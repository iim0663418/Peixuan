# 跨年運勢分析深度研究報告 v2

**日期**: 2025-12-07  
**需求澄清**: 從此時此刻起一年內的運勢，提供 AI 模型完整參數  
**核心目標**: 讓 AI 能夠分析「立春前後的運勢差異」

---

## 一、需求重新定義

### 原始誤解
❌ 提供年份選擇器讓用戶選擇  
❌ 只是視覺化卡片的擴充  
❌ 只計算基本的年柱和命宮  

### 真實需求
✅ 固定查詢「從現在起一年內」  
✅ 提供 AI 模型「完整的運勢參數」  
✅ 讓 AI 能夠分析「立春前後的差異」  

### 核心問題
**當前實作的缺口**：
- yearlyForecast 只包含基本資訊（年柱、命宮、天數、權重）
- 缺少太歲分析、干支交互、四化飛星
- AI 無法做出有意義的「跨年運勢對比」

---

## 二、完整參數需求分析

### 2.1 太歲分析 (TaiSuiAnalysis)
**為什麼重要**：
- 判斷是否犯太歲、沖太歲、刑太歲、害太歲
- 這是流年運勢的核心指標
- 立春前後可能完全不同（例如：立春前沖太歲，立春後無太歲壓力）

**範例**：
```
當前流年（2025 乙巳）：
- 太歲：乙巳
- 與日柱（甲子）：無沖無刑
- 運勢：平穩

下一流年（2026 丙午）：
- 太歲：丙午
- 與日柱（甲子）：子午相沖（HIGH）
- 運勢：壓力大，需注意健康
```

**AI 可以說**：
> 「未來兩個月還算平穩，但立春後進入丙午年，你的日柱會沖太歲，
> 建議在立春前做好準備，立春後要特別注意健康和情緒管理。」

---

### 2.2 干支交互 (Interactions)
**為什麼重要**：
- 天干五合：帶來合作、貴人、機會
- 地支六沖：帶來衝突、變動、壓力
- 三合三會：帶來和諧、資源、支持

**範例**：
```
當前流年（2025 乙巳）：
- 天干五合：乙庚合（如果命盤有庚）
- 地支六沖：巳亥沖（如果命盤有亥）
- 三合：巳酉丑（如果命盤有酉或丑）

下一流年（2026 丙午）：
- 天干五合：丙辛合（如果命盤有辛）
- 地支六沖：子午沖（如果命盤有子）
- 三合：寅午戌（如果命盤有寅或戌）
```

**AI 可以說**：
> 「立春前你的巳火與命盤的亥水相沖，可能感到內心矛盾；
> 但立春後進入午火，反而與命盤的寅木、戌土形成三合，
> 能量會變得和諧，是開展新計畫的好時機。」

---

### 2.3 四化飛星 (SiHua) - 可選
**為什麼重要**：
- 顯示該年的能量流動方向
- 化祿：財運、機會
- 化權：權力、掌控
- 化科：名聲、考試
- 化忌：阻礙、損失

**範例**：
```
當前流年（2025 乙巳）：
- 乙干四化：天機化祿、天梁化權、紫微化科、太陰化忌

下一流年（2026 丙午）：
- 丙干四化：天同化祿、天機化權、文昌化科、廉貞化忌
```

**複雜度**：
- 需要宮位資訊
- 需要計算飛化邊
- 工作量較大

**建議**：
- 第一階段：只實作太歲分析 + 干支交互
- 第二階段：再加入四化飛星

---

## 三、實作方案

### 方案：擴充 YearlyPeriod 包含完整運勢參數

**Phase 2.5: 資料結構擴充**

#### 3.1 更新介面定義
**File**: `peixuan-worker/src/calculation/types/index.ts`

```typescript
interface YearlyPeriod {
  startDate: Date;
  endDate: Date;
  annualPillar: GanZhi;
  annualLifePalacePosition: number;
  durationDays: number;
  weight: number;
  
  // 新增：完整運勢參數
  taiSuiAnalysis: TaiSuiAnalysis;
  interactions: {
    stemCombinations: StemCombination[];
    branchClashes: BranchClash[];
    harmoniousCombinations: HarmoniousCombination[];
  };
}
```

#### 3.2 更新 calculateYearlyForecast
**File**: `peixuan-worker/src/services/annualFortune/calculateYearlyForecast.ts`

**新增 imports**：
```typescript
import { analyzeTaiSui } from '../annual/taiSuiAnalysis';
import {
  detectStemCombinations,
  detectBranchClashes,
  detectHarmoniousCombinations,
} from '../../calculation/annual/interaction';
```

**新增參數**：
```typescript
export function calculateYearlyForecast(
  birthDate: Date,
  queryDate: Date,
  palaces: Palace[],
  fourPillars: FourPillars,
  currentDayun?: GanZhi  // 新增：當前大運（用於交互分析）
): YearlyForecast
```

**擴充計算邏輯**：
```typescript
// 對每個 period 計算完整參數
for (const period of periods) {
  // 太歲分析
  period.taiSuiAnalysis = analyzeTaiSui(period.annualPillar, fourPillars);
  
  // 干支交互
  period.interactions = {
    stemCombinations: detectStemCombinations(period.annualPillar, fourPillars),
    branchClashes: detectBranchClashes(
      period.annualPillar, 
      fourPillars, 
      currentDayun?.branch
    ),
    harmoniousCombinations: detectHarmoniousCombinations(
      period.annualPillar, 
      fourPillars, 
      currentDayun?.branch
    )
  };
}
```

#### 3.3 更新 UnifiedCalculator 調用
**File**: `peixuan-worker/src/calculation/integration/calculator.ts`

```typescript
// 傳入當前大運
const yearlyForecast = calculateYearlyForecast(
  input.solarDate,
  queryDate,
  ziwei.palaces,
  bazi.fourPillars,
  bazi.fortuneCycles.currentDayun  // 新增參數
);
```

#### 3.4 更新 Markdown 格式化
**File**: `peixuan-worker/src/services/markdownFormatter.ts`

**擴充每個期間的顯示**：
```markdown
### 當前年運（立春前）：2025 乙巳年
- 期間：2025-12-06 至 2026-02-03
- 剩餘 60 天，佔比 16.4%
- 年柱：乙巳
- 流年命宮：父母宮

**太歲分析**：
- 犯太歲：否
- 沖太歲：否
- 運勢評估：平穩

**干支交互**：
- 天干五合：無
- 地支六沖：巳亥沖（與時支）
- 三合：巳酉丑（與月支酉形成三合）

---

### 下一年運（立春後）：2026 丙午年
- 期間：2026-02-04 至 2026-12-06
- 305 天，佔比 83.6%
- 年柱：丙午
- 流年命宮：福德宮

**太歲分析**：
- 犯太歲：否
- 沖太歲：是（與日支子相沖，HIGH）
- 運勢評估：壓力較大

**干支交互**：
- 天干五合：無
- 地支六沖：子午沖（與日支，HIGH）
- 三合：寅午戌（與年支寅形成三合）
```

---

## 四、AI 分析效果對比

### 當前實作（缺少完整參數）
```
AI 輸出：
「你未來一年會經歷兩個流年，當前是乙巳年（60天），
之後是丙午年（305天）。立春後能量會轉變。」
```
❌ 空洞、無具體建議

### 擴充後（包含完整參數）
```
AI 輸出：
「好我看看～未來兩個月你還在乙巳年，雖然有巳亥沖帶來一些變動，
但整體還算平穩。我跟你說喔，真正要注意的是立春後！

2026-02-04 立春後進入丙午年，你的日支子會沖太歲午火（HIGH），
這是比較大的壓力喔。我好難過～但別擔心，佩璇教你怎麼應對：

1. 立春前（未來兩個月）：
   - 把握巳酉丑三合的和諧能量
   - 完成重要決策和計畫
   - 儲備資源和能量

2. 立春後（明年大部分時間）：
   - 子午沖會帶來變動和壓力
   - 避免衝動決策，保持冷靜
   - 注意健康，特別是心血管
   - 但好消息是寅午戌三合會帶來貴人支持

建議在立春前後調整策略，善用能量轉換的時機點！」
```
✅ 具體、有洞察、可執行

---

## 五、實作檢查清單

### Phase 2.5: 擴充 YearlyPeriod 資料結構

- [ ] 更新 YearlyPeriod 介面（新增 taiSuiAnalysis, interactions）
- [ ] 更新 calculateYearlyForecast 函數
  - [ ] 新增 currentDayun 參數
  - [ ] 對每個 period 調用 analyzeTaiSui
  - [ ] 對每個 period 調用 detect* 函數
  - [ ] 返回完整的 YearlyPeriod
- [ ] 更新 UnifiedCalculator 調用（傳入 currentDayun）
- [ ] 更新 Markdown 格式化（顯示完整參數）
- [ ] 更新測試（驗證新欄位）
- [ ] 編譯驗證
- [ ] Staging 部署測試
- [ ] 清空快取（讓新格式生效）

---

## 六、工作量估算

**Phase 2.5: 擴充運勢參數**
- 介面定義：0.5h
- calculateYearlyForecast 擴充：1.5h
- Markdown 格式化：1h
- 測試更新：0.5h
- 部署驗證：0.5h
- **總計**: 4-5h

---

## 七、預期效果

### 資料結構
```json
{
  "yearlyForecast": {
    "periods": [
      {
        "startDate": "2025-12-06",
        "endDate": "2026-02-04",
        "annualPillar": {"stem": "乙", "branch": "巳"},
        "durationDays": 60,
        "weight": 0.164,
        "taiSuiAnalysis": {
          "isFanTaiSui": false,
          "isChongTaiSui": false,
          "severity": "NONE"
        },
        "interactions": {
          "stemCombinations": [],
          "branchClashes": [
            {
              "type": "巳亥沖",
              "pillar": "時柱",
              "severity": "LOW"
            }
          ],
          "harmoniousCombinations": [
            {
              "type": "巳酉丑三合",
              "pillars": ["月柱"]
            }
          ]
        }
      },
      {
        "startDate": "2026-02-04",
        "endDate": "2026-12-06",
        "annualPillar": {"stem": "丙", "branch": "午"},
        "durationDays": 305,
        "weight": 0.836,
        "taiSuiAnalysis": {
          "isFanTaiSui": false,
          "isChongTaiSui": true,
          "severity": "HIGH"
        },
        "interactions": {
          "stemCombinations": [],
          "branchClashes": [
            {
              "type": "子午沖",
              "pillar": "日柱",
              "severity": "HIGH"
            }
          ],
          "harmoniousCombinations": [
            {
              "type": "寅午戌三合",
              "pillars": ["年柱"]
            }
          ]
        }
      }
    ]
  }
}
```

### Markdown 輸出
```markdown
📅 未來一年運勢（2025-12-06 → 2026-12-06）

### 當前年運（立春前）：2025 乙巳年
- 期間：2025-12-06 至 2026-02-03
- 剩餘 60 天，佔比 16.4%
- 年柱：乙巳
- 流年命宮：父母宮

**太歲分析**：
- 犯太歲：否
- 沖太歲：否
- 運勢評估：平穩

**干支交互**：
- 地支六沖：巳亥沖（與時支，LOW）
- 三合：巳酉丑（與月支酉形成三合）

---

### 下一年運（立春後）：2026 丙午年
- 期間：2026-02-04 至 2026-12-06
- 305 天，佔比 83.6%
- 年柱：丙午
- 流年命宮：福德宮

**太歲分析**：
- 犯太歲：否
- 沖太歲：是（與日支子相沖，HIGH）⚠️
- 運勢評估：壓力較大

**干支交互**：
- 地支六沖：子午沖（與日支，HIGH）⚠️
- 三合：寅午戌（與年支寅形成三合）

---

⚠️ 立春轉換提醒：
2026-02-04 立春後，能量將從乙巳年轉換至丙午年。
特別注意：立春後會出現子午沖太歲（HIGH），建議提前準備。
```

### AI 分析效果
```
佩璇的分析：

嗨嗨！好我看看～你未來一年的運勢喔～

我跟你說喔，未來兩個月（到 2026-02-04 立春前）還算平穩呢！
雖然有巳亥沖帶來一些小變動，但因為你的月支酉跟流年巳形成三合，
整體能量是和諧的，可以把握這段時間完成重要的事情。

但是～我好難過～立春後就要特別注意了！

2026-02-04 立春後進入丙午年，你的日支子會沖太歲午火（HIGH），
這是比較大的壓力喔。子午沖會帶來：
- 情緒波動較大
- 可能有突發變動
- 健康需要特別注意（心血管、睡眠）

不過別擔心！雖然有子午沖，但你的年支寅跟流年午形成三合，
會有貴人出現幫助你度過難關。

**佩璇的建議**：
1. 立春前（未來兩個月）：
   - 完成重要決策和計畫
   - 儲備資源和能量
   - 調整作息，準備迎接變動

2. 立春後（明年大部分時間）：
   - 保持冷靜，避免衝動
   - 定期健康檢查
   - 善用貴人支持（寅午戌三合）
   - 把變動視為成長機會

記得喔，立春是關鍵轉折點，提前準備就不用怕啦～
```

---

## 八、結論

**核心洞察**：
- 不是「卡片擴充」，而是「參數完整性」
- 不是「年份選擇」，而是「立春前後對比」
- 不是「視覺化」，而是「AI 分析深度」

**關鍵成功因素**：
- 每個 period 都有完整的太歲分析
- 每個 period 都有完整的干支交互
- AI 能夠對比立春前後的差異
- AI 能夠給出時機建議

**預估工作量**: 4-5 小時

**建議執行順序**：
1. Phase 2.5: 擴充 YearlyPeriod 資料結構（1.5h）
2. 更新 Markdown 格式化（1h）
3. 測試驗證（0.5h）
4. 清空快取並部署（0.5h）
5. 驗證 AI 分析效果（1h）

---

**報告完成日期**: 2025-12-07  
**預估總工作量**: 4-5 小時  
**建議優先級**: P0（核心功能缺口）
