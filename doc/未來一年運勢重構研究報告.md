# 未來一年運勢重構研究報告

**日期**: 2025-12-06  
**需求**: 將「明年運勢」改為「現在起一年內的運勢」  
**影響等級**: 🔴 重大變更

---

## 一、需求分析

### 當前設計
- **時間範圍**: 下一個完整農曆年（明年立春 → 後年立春）
- **計算基準**: 固定的農曆年界
- **用戶認知**: 「明年會怎樣？」

### 新需求
- **時間範圍**: 從今天開始的 365 天（滾動窗口）
- **計算基準**: 當前日期 + 1 年
- **用戶認知**: 「未來一年會怎樣？」

### 核心差異
| 維度 | 當前設計 | 新需求 |
|------|---------|--------|
| 時間模型 | 固定農曆年 | 滾動日曆年 |
| 流年數量 | 1 個（下一年） | 1-2 個（當前+下一） |
| 立春處理 | 年界分隔 | 過渡期標記 |
| 快取策略 | 按 chartId | 按 chartId + 日期 |
| 複雜度 | 低 | 高 |

---

## 二、技術挑戰

### 2.1 雙流年計算
**問題**: 一年內可能跨越兩個農曆年

**範例**:
```
查詢日期: 2025-12-06
時間範圍: 2025-12-06 → 2026-12-06
立春日期: 2026-02-04

當前流年: 2025 乙巳年
  - 期間: 2025-12-06 → 2026-02-03
  - 天數: 60 天
  - 權重: 16%

下一流年: 2026 丙午年
  - 期間: 2026-02-04 → 2026-12-06
  - 天數: 305 天
  - 權重: 84%
```

**解決方案**: 雙流年加權模型
```typescript
interface YearlyForecast {
  startDate: Date;
  endDate: Date;
  currentYear: {
    pillar: GanZhi;
    lifePalace: number;
    duration: number;     // 天數
    weight: number;       // 權重 0-1
    sihua: SiHua[];
  };
  nextYear: {
    pillar: GanZhi;
    lifePalace: number;
    duration: number;
    weight: number;
    sihua: SiHua[];
  };
  lichunDate: Date;       // 分界點
}
```

### 2.2 大運交互
**問題**: 一年內可能跨越兩個大運週期

**範例**:
```
出生日期: 1990-01-01
查詢日期: 2025-12-06（35 歲）
大運列表:
  - 29-39 歲: 丙午大運（至 2029-01-01）
  - 39-49 歲: 丁未大運（從 2029-01-01）

時間範圍: 2025-12-06 → 2026-12-06
  - 丙午大運: 100%（未跨越）
```

**解決方案**: 大運期間查詢
```typescript
function getDayunPeriodsInRange(
  birthDate: Date,
  startDate: Date,
  endDate: Date,
  dayunList: DaYun[]
): DayunPeriod[]
```

### 2.3 四化飛星權重
**問題**: 兩個流年的四化如何整合？

**方案 A**: 分別計算，標記權重
```typescript
interface WeightedSiHua extends SiHua {
  weight: number;       // 基於時間佔比
  period: 'current' | 'next';
}
```

**方案 B**: 合併計算，加權邊
```typescript
const weightedEdges = [
  ...currentYearSihua.map(s => ({ ...s, weight: 0.16 })),
  ...nextYearSihua.map(s => ({ ...s, weight: 0.84 }))
];
```

### 2.4 快取策略
**問題**: 查詢日期不同，結果不同

**當前**: `chartId_analysisType`  
**新需求**: `chartId_analysisType_queryDate`

**快取粒度選擇**:
- 按日快取：精確但快取命中率低
- 按週快取：平衡方案（7 天內共用）
- 按月快取：命中率高但精確度降低

**建議**: 按日快取 + 24h TTL

---

## 三、影響範圍

### 3.1 後端計算層
**檔案**:
- `peixuan-worker/src/services/annualFortune/getAnnualPillar.ts`
- `peixuan-worker/src/services/annualFortune/locateAnnualLifePalace.ts`
- `peixuan-worker/src/services/annualFortune/detectInteractions.ts`
- **新增**: `peixuan-worker/src/services/annualFortune/calculateYearlyForecast.ts`

**變更**:
- 支援「當前年」計算（不只是「下一年」）
- 雙流年命宮定位
- 雙流年交互分析
- 立春日期查詢函數

### 3.2 資料結構
**檔案**:
- `peixuan-worker/src/types/calculationResult.ts`

**變更**:
```typescript
// 舊介面（保留向後相容）
interface AnnualFortune {
  nextYear: {
    pillar: GanZhi;
    lifePalace: number;
    // ...
  };
}

// 新介面
interface AnnualFortune {
  nextYear: GanZhi;  // @deprecated 使用 yearlyForecast
  yearlyForecast: YearlyForecast;  // 新欄位
}
```

### 3.3 Markdown 格式化
**檔案**:
- `peixuan-worker/src/services/markdownFormatter.ts`

**變更**:
```markdown
# 舊格式
## 明年運勢（2026 丙午年）

# 新格式
## 未來一年運勢（2025-12-06 → 2026-12-06）

### 當前流年：2025 乙巳年（剩餘 60 天）
- 至 2026-02-03 立春

### 下一流年：2026 丙午年（305 天）
- 2026-02-04 立春起

⚠️ **過渡期提醒**：
未來兩個月仍在 2025 乙巳年影響下...
```

### 3.4 Gemini Prompt
**檔案**:
- `peixuan-worker/src/services/geminiService.ts`

**變更**:
```typescript
// 舊 Prompt
"分析明年（2026 丙午年）的運勢..."

// 新 Prompt
"分析從現在起一年內的運勢...
當前流年：2025 乙巳年（剩餘 60 天，16%）
下一流年：2026 丙午年（305 天，84%）
請特別說明立春前後的能量轉換..."
```

### 3.5 前端顯示
**檔案**:
- `bazi-app-vue/src/components/AnnualFortuneCard.vue`

**變更**:
- 標題：「明年運勢」→「未來一年運勢」
- 新增時間範圍顯示
- 新增雙流年視覺化（時間軸）
- 新增過渡期提示

### 3.6 快取服務
**檔案**:
- `peixuan-worker/src/services/analysisCacheService.ts`
- `peixuan-worker/src/services/advancedAnalysisCacheService.ts`

**變更**:
- 快取 key 包含查詢日期
- TTL 調整為 24h（每日更新）

---

## 四、實作方案

### 方案 A：雙流年加權模型（推薦）

**優點**:
- ✅ 精確反映實際時間影響
- ✅ 保留農曆年的完整性
- ✅ 可分析過渡期特殊影響
- ✅ 專業度高，差異化明顯

**缺點**:
- ❌ 複雜度較高
- ❌ 需要兩次四化計算
- ❌ Prompt 需處理雙流年敘事

**工作量**: 13-19 小時

**階段**:
1. Phase 1: 後端計算核心（4-6h）
2. Phase 2: 資料結構擴充（2-3h）
3. Phase 3: Markdown 與 Prompt（2-3h）
4. Phase 4: 前端適配（3-4h）
5. Phase 5: 測試與優化（2-3h）

---

### 方案 B：主流年簡化模型

**優點**:
- ✅ 實作簡單
- ✅ 與現有邏輯相容
- ✅ 用戶理解容易

**缺點**:
- ❌ 損失精確度
- ❌ 忽略過渡期影響
- ❌ 專業度較低

**工作量**: 6-8 小時

---

### 方案 C：漸進式遷移

**第一階段**: 「今天到明年立春」（3-5h）
- 時間範圍：今天 → 下一個立春
- 單一流年，邏輯簡單
- 快速上線

**第二階段**: 「完整一年」（10-14h）
- 時間範圍：今天 → 一年後
- 雙流年加權
- 完整功能

**優點**:
- ✅ 風險可控
- ✅ 可分階段驗證
- ✅ 用戶逐步適應

**缺點**:
- ❌ 總工作量較高（13-19h）
- ❌ 需要兩次部署

---

### 方案 D：用戶選擇模式

**功能**:
```typescript
enum ForecastMode {
  NEXT_YEAR = 'next_year',      // 明年運勢（傳統）
  ONE_YEAR = 'one_year',         // 未來一年（新功能）
  CUSTOM_RANGE = 'custom_range'  // 自訂範圍（進階）
}
```

**優點**:
- ✅ 保留舊功能
- ✅ 最大彈性
- ✅ 滿足不同用戶需求

**缺點**:
- ❌ UI 複雜度增加
- ❌ 維護成本高
- ❌ 用戶選擇困難

**工作量**: 15-20 小時

---

## 五、風險評估

### 高風險
- 🔴 **快取失效**: 需要包含查詢日期，舊快取全部失效
- 🔴 **向後相容性**: 舊 API 回應格式需保留
- 🔴 **AI 敘事複雜度**: 雙流年描述需要精心設計

### 中風險
- 🟡 **立春日期計算**: 需要精確到時分秒
- 🟡 **大運交互邏輯**: 跨大運情況需特殊處理
- 🟡 **前端視覺化**: 時間軸設計需要 UX 考量

### 低風險
- 🟢 **資料結構擴充**: 可保持向後相容
- 🟢 **Markdown 格式化**: 純文字變更
- 🟢 **單元測試覆蓋**: 邊界情況可完整測試

---

## 六、建議決策

### 推薦方案：方案 A（雙流年加權模型）

**理由**:
1. **精確度**: 真實反映一年內的能量變化
2. **專業性**: 符合命理學的時間觀念（立春為界）
3. **差異化**: 市面上少見的「滾動一年」預測
4. **可擴展**: 未來可支援「任意時間範圍」預測

### 替代方案（如時間/資源有限）

**快速上線**: 方案 C 第一階段（3-5h）
- 「今天到明年立春」
- 單一流年，邏輯簡單
- 後續可升級為完整版

**最大彈性**: 方案 D（15-20h）
- 用戶可選擇模式
- 保留舊功能
- 適合 A/B 測試

---

## 七、實作檢查清單

### Phase 1: 後端計算核心
- [ ] 實作 `calculateYearlyForecast` 函數
- [ ] 實作 `getLichunDatesBetween` 函數
- [ ] 實作雙流年權重計算
- [ ] 實作雙流年命宮定位
- [ ] 實作雙流年四化計算
- [ ] 單元測試（邊界情況）

### Phase 2: 資料結構擴充
- [ ] 新增 `YearlyForecast` 介面
- [ ] 更新 `CalculationResult.annualFortune`
- [ ] 標記舊欄位為 `@deprecated`
- [ ] 更新 TypeScript 類型定義

### Phase 3: Markdown 與 Prompt
- [ ] 更新 `markdownFormatter` 雙流年格式
- [ ] 調整 `buildAdvancedAnalysisPrompt`
- [ ] 新增時間範圍說明
- [ ] 新增過渡期提示
- [ ] AI 敘事範例更新

### Phase 4: 前端適配
- [ ] 更新 `AnnualFortuneCard` 組件
- [ ] 新增時間範圍顯示
- [ ] 新增時間軸視覺化
- [ ] 新增過渡期提示 UI
- [ ] i18n 文案更新（中英文）

### Phase 5: 測試與優化
- [ ] 端到端測試
- [ ] 快取策略調整
- [ ] 性能優化
- [ ] 文件更新
- [ ] Staging 部署測試
- [ ] Production 部署

---

## 八、時程規劃

### 最小可行版本（MVP）
- **工作量**: 13-19 小時
- **時程**: 2-3 天（全職）或 1-2 週（兼職）
- **範圍**: 方案 A 完整實作

### 快速上線版本
- **工作量**: 3-5 小時
- **時程**: 1 天
- **範圍**: 方案 C 第一階段

### 完整功能版本
- **工作量**: 15-20 小時
- **時程**: 3-4 天（全職）
- **範圍**: 方案 D（含用戶選擇）

---

## 九、後續優化方向

### 短期（1-2 週）
- 用戶反饋收集
- AI 敘事優化
- 視覺化改進

### 中期（1-2 月）
- 自訂時間範圍功能
- 多時間點比較
- 歷史運勢回顧

### 長期（3-6 月）
- 機器學習預測
- 個性化建議
- 社群分享功能

---

## 十、結論

「未來一年運勢」是一個**重大但有價值**的功能變更。

**建議採用方案 A（雙流年加權模型）**，理由：
1. 精確度與專業性兼具
2. 差異化競爭優勢
3. 可擴展性強
4. 工作量可控（13-19h）

**如需快速驗證**，可先實作方案 C 第一階段（3-5h），後續再升級為完整版。

**關鍵成功因素**:
- 立春日期計算精確度
- AI 敘事的流暢性
- 前端視覺化的直觀性
- 快取策略的合理性

---

**報告完成日期**: 2025-12-06  
**預估總工作量**: 13-19 小時（方案 A）  
**建議優先級**: P1（高優先級）
