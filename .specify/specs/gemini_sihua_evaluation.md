# 四化飛星核心算法優化技術評估報告
## 評估日期: 2026-01-02

本報告基於現有的檢查報告與技術棧優化方案，針對四化飛星模組的重構與優化進行綜合技術評估。

### 1. 問題嚴重性分析 (Severity Analysis)

*   **宮位天干計算邏輯錯誤 (Critical)**
    *   **現狀**：目前使用線性遞增方式計算宮位天干，這違反了紫微斗數中「五虎遁」或「五鼠遁」的起干法則。
    *   **影響**：這是核心業務邏輯的根本性錯誤。宮幹錯誤將導致「宮幹自化」、「飛星入宮」等高階推演完全失效，直接破壞命理分析的準確性。此問題屬於**最高危**級別，必須立即修正。
*   **星曜查找算法效能 (Major)**
    *   **現狀**：O(n) 的線性搜尋在星曜數量增加或頻繁調用（如流年流月運算）時，會造成顯著的性能瓶頸。
    *   **影響**：導致 API 響應延遲，特別是在進行複雜的圖論能量分析時，會成倍放大計算時間。
*   **輸入驗證缺失 (Moderate)**
    *   **現狀**：缺乏邊界檢查與錯誤處理。
    *   **影響**：雖然不影響正常計算，但容易因異常數據導致服務崩潰或產生不可預期的 NaN 結果，影響系統強健性。

### 2. 技術方案可行性 (Feasibility)

*   **TypeScript Const Assertion & Map 映射 (High Feasibility)**
    *   利用 TS 的 `as const` 與靜態 Map 結構來處理天干地支對應，是標準且高效的工程實踐。不僅解決了邏輯錯誤，還利用編譯器進行靜態檢查，幾乎無運行時開銷。
*   **Map 預索引 (High Feasibility)**
    *   將星曜查找從 Array.find 改為 Map.get 是極低成本的重構，且 Cloudflare Workers 環境對 ES6+ 特性支援完善，完全可行。
*   **Memoization & WeakMap (Medium Feasibility)**
    *   雖然 Memoization 能有效減少圖論計算開銷，但在 Serverless (Workers) 環境下，實例生命週期短，內存緩存的效果取決於請求的併發模型。需注意內存洩漏風險，使用 `WeakMap` 是正確的選擇。

### 3. 實施風險評估 (Risk Assessment)

*   **回歸測試風險 (High)**
    *   修正宮位天干計算將導致**所有**現有的測試快照（Snapshots）失效。必須重新驗證所有測試案例，確保新的計算結果符合命理理論，而非僅僅是更新快照。
*   **數據結構遷移風險 (Low)**
    *   統一星曜數據結構可能涉及多個檔案的修改，需確保所有引用處都已更新，否則會出現 `undefined` 錯誤。

### 4. ROI 分析 (Return on Investment)

| 優化項目 | 投入成本 (Cost) | 預期收益 (Benefit) | ROI |
| :--- | :--- | :--- | :--- |
| **宮位天干修正** | 低 (修改邏輯表) | **極高** (產品可用性從 0 到 1) | ⭐⭐⭐⭐⭐ |
| **星曜查找優化** | 低 (重構索引) | 高 (性能提升 1200%) | ⭐⭐⭐⭐ |
| **圖算法 Memoization** | 中 (需調試與驗證) | 中 (視併發量而定) | ⭐⭐⭐ |

### 5. 優先級建議 (Recommendations)

基於上述分析，建議採用以下實施順序：

1.  **P0 - 核心邏輯修復 (立即執行)**：
    *   實作 `EARTHLY_BRANCH_STEM_MAP` 並修正 `getPalaceStem()`。這是產品能否上線的關鍵。
    *   同步更新單元測試，並人工驗證至少 3-5 個真實命盤案例。
2.  **P1 - 數據結構統一與查找優化**：
    *   實施 `Map` 索引機制，解決性能瓶頸。
    *   補全輸入驗證與邊界檢查，提升系統強健性。
3.  **P2 - 進階效能優化**：
    *   在核心邏輯穩定後，再引入 Memoization 優化圖算法。這屬於「錦上添花」，不應阻礙前兩項的修復。

### 結論
該技術優化方案方向正確且必要。目前的宮位天干計算錯誤是致命缺陷，必須作為當前的唯一重點任務進行修復。性能優化方案具備高可行性，建議在邏輯修復後緊接著實施。
