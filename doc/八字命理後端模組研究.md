

# **中華形而上學計算架構：八字與紫微斗數後端系統深度研究報告**

## **1\. 執行摘要與系統架構總論**

### **1.1 研究背景與目標**

隨著數位人文學（Digital Humanities）的興起，將傳統中華形而上學（Chinese Metaphysics）——特別是子平八字（BaZi）與紫微斗數（ZiWei DouShu）——轉化為高精度的計算模型，已成為現代命理科技化的核心挑戰。本報告旨在為一套專家級的命理後端系統提供詳盡的架構設計與演算法規範。該系統不僅需處理基礎的五行計數，更需解決「藏干權重量化」、「真太陽時起運計算」、「流年動態映射」以及基於「圖論（Graph Theory）」的四化飛星路徑分析等高階問題。

本報告將嚴格遵循軟體工程與數據科學的標準，將玄學概念解構為可編程的數據結構、演算法邏輯與資料庫模型，以滿足 15,000 字的深度技術規範要求。

### **1.2 系統核心模組概覽**

為滿足用戶提出的四大核心需求，本後端架構被劃分為四個相互獨立但數據耦合的微服務模組：

1. **五行量化分析引擎 (WuXing Quantitative Engine)**：負責靜態命盤的解析，從單純的干支計數進階到包含「藏干權重」與「月令強弱係數」的向量化評分系統。  
2. **時空大運演算器 (Chronological Fortune Engine)**：基於天文曆法（Ephemeris）計算精確到分鐘的節氣交接，推導大運起訖點與順逆邏輯。  
3. **流年動態交互層 (Annual Interaction Layer)**：處理流年（歲君）與本命盤的動態碰撞，包含干支合沖刑害的矩陣運算及流年命宮的定位。  
4. **圖論飛星分析儀 (Graph-Theoretical SiHua Analyzer)**：引入有向圖（Directed Graph）技術，將紫微斗數的四化飛星建模為網絡流動，以演算法識別「壓力匯聚點（Sink Nodes）」與「資源源頭（Source Nodes）」。

---

## **2\. 五行分布統計 (WuXingDistribution)：從符號到向量的量化工程**

八字命理的基礎在於五行（木、火、土、金、水）的平衡分析。然而，傳統的「數個數」方法（例如：2個木、1個火）過於粗糙，無法反映命盤的真實能量結構。後端系統必須實作一套基於「藏干（Hidden Stems）」與「月令權重（Seasonality）」的加權演算法。

### **2.1 天干五行計數 (Tiangan Analysis)**

天干（Heavenly Stems）代表命主外顯的特質與能量，也就是所謂的「表氣」。在數據結構中，天干應被視為能量的直接發射源，其權重通常設定為基準值（1.0）。

#### **2.1.1 數據結構定義**

系統首先需建立天干的屬性映射表（Mapping Table）。這不應僅是簡單的鍵值對，而應包含陰陽屬性與生剋關係，以便後續運算。

| ID | 天干 | 五行 (Element) | 陰陽 (Polarity) | 基準權重 (Base Weight) |
| :---- | :---- | :---- | :---- | :---- |
| 0 | 甲 (Jia) | 木 (Wood) | 陽 (+) | 1.0 |
| 1 | 乙 (Yi) | 木 (Wood) | 陰 (-) | 1.0 |
| 2 | 丙 (Bing) | 火 (Fire) | 陽 (+) | 1.0 |
| 3 | 丁 (Ding) | 火 (Fire) | 陰 (-) | 1.0 |
| 4 | 戊 (Wu) | 土 (Earth) | 陽 (+) | 1.0 |
| 5 | 己 (Ji) | 土 (Earth) | 陰 (-) | 1.0 |
| 6 | 庚 (Geng) | 金 (Metal) | 陽 (+) | 1.0 |
| 7 | 辛 (Xin) | 金 (Metal) | 陰 (-) | 1.0 |
| 8 | 壬 (Ren) | 水 (Water) | 陽 (+) | 1.0 |
| 9 | 癸 (Gui) | 水 (Water) | 陰 (-) | 1.0 |

#### **2.1.2 演算法邏輯**

對於用戶輸入的四柱八字，系統首先提取四個天干進行頻率統計。

* **輸入**：\`\`  
* **初步處理**：  
  * 木 (甲) count: 1  
  * 火 (丙) count: 1  
  * 土 (戊) count: 1  
  * 金 (庚) count: 1  
  * 水 count: 0

這僅是第一層數據。後端需將此數據存儲為 RawStemCount 物件，作為後續加權計算的基礎。

### **2.2 地支與藏干五行計數 (Dizhi & Hidden Stems)**

地支（Earthly Branches）不僅代表時間與方位，更是五行的容器。地支的複雜性在於其內部包含的「藏干」。精確的五行分析必須將地支「解壓縮」為其內部的天干成分。

#### **2.2.1 藏干權重模型 (Weight Distribution Model)**

這是後端開發的關鍵決策點。不同的命理流派（如子平法、盲派、新派）對藏干的權重分配有不同見解。為了保持系統的靈活性，建議採用**策略模式 (Strategy Pattern)** 來設計權重計算模組。

以下採用最通用的「分氣法」進行權重設定：

* **本氣 (Main Qi)**：地支的主導能量，通常佔 60% \- 100%。  
* **中氣 (Middle Qi)**：長生或庫藏的能量，通常佔 30%。  
* **餘氣 (Remnant Qi)**：上一個季節的殘留能量，通常佔 10%。

**地支藏干權重配置表 (JSON Schema 範例)：**

JSON

{  
  "Zi":  { "Gui": 1.0 },  
  "Chou":{ "Ji": 0.60, "Gui": 0.30, "Xin": 0.10 },  
  "Yin": { "Jia": 0.60, "Bing": 0.30, "Wu": 0.10 },  
  "Mao": { "Yi": 1.0 },  
  "Chen":{ "Wu": 0.60, "Yi": 0.30, "Gui": 0.10 },  
  "Si":  { "Bing": 0.60, "Wu": 0.30, "Geng": 0.10 },  
  "Wu":  { "Ding": 0.70, "Ji": 0.30 },  
  "Wei": { "Ji": 0.60, "Ding": 0.30, "Yi": 0.10 },  
  "Shen":{ "Geng": 0.60, "Ren": 0.30, "Wu": 0.10 },  
  "You": { "Xin": 1.0 },  
  "Xu":  { "Wu": 0.60, "Xin": 0.30, "Ding": 0.10 },  
  "Hai": { "Ren": 0.70, "Jia": 0.30 }  
}

#### **2.2.2 計算演算法**

系統遍歷四柱的地支，依據上述權重表將地支轉化為五行分數。

案例模擬：  
假設命盤地支為 { 年: 子, 月: 寅, 日: 辰, 時: 酉 }。

1. **年支 (子 \- Zi)**：  
   * 水 (Gui): \+ 1.0  
2. **月支 (寅 \- Yin)**：  
   * 木 (Jia): \+ 0.6  
   * 火 (Bing): \+ 0.3  
   * 土 (Wu): \+ 0.1  
3. **日支 (辰 \- Chen)**：  
   * 土 (Wu): \+ 0.6  
   * 木 (Yi): \+ 0.3  
   * 水 (Gui): \+ 0.1  
4. **時支 (酉 \- You)**：  
   * 金 (Xin): \+ 1.0

**地支加權總計**：

* 木：0.6 (寅) \+ 0.3 (辰) \= 0.9  
* 火：0.3 (寅)  
* 土：0.1 (寅) \+ 0.6 (辰) \= 0.7  
* 金：1.0 (酉)  
* 水：1.0 (子) \+ 0.1 (辰) \= 1.1

此時，我們得到了一個更加細膩的五行分布圖，這比單純的「2土1金1水」要精確得多，揭示了命盤中隱藏的木氣（來自辰土的木庫和寅木）。

### **2.3 總體五行分數 (Total WuXing Score) 與月令調整**

單純的加權總和仍然不足以反映「旺衰」。在八字理論中，**月令 (Month Branch)** 是提綱，決定了五行的旺相休囚死。後端必須實作「月令係數調整 (Seasonality Adjustment)」。

#### **2.3.1 月令強弱係數矩陣**

系統需判斷月支所屬的季節，並對應調整各五行的得分。

| 月令季節 | 旺 (Multiplier \> 1.0) | 相 (Multiplier \> 1.0) | 休 (Multiplier \< 1.0) | 囚 (Multiplier \< 1.0) | 死 (Multiplier \< 0.5) |
| :---- | :---- | :---- | :---- | :---- | :---- |
| 春 (寅卯) | 木 (x 1.5) | 火 (x 1.3) | 水 (x 1.0) | 土 (x 0.7) | 金 (x 0.5) |
| 夏 (巳午) | 火 (x 1.5) | 土 (x 1.3) | 木 (x 1.0) | 金 (x 0.7) | 水 (x 0.5) |
| 秋 (申酉) | 金 (x 1.5) | 水 (x 1.3) | 土 (x 1.0) | 木 (x 0.7) | 火 (x 0.5) |
| 冬 (亥子) | 水 (x 1.5) | 木 (x 1.3) | 金 (x 1.0) | 火 (x 0.7) | 土 (x 0.5) |
| 四季 (辰戌丑未) | 土 (x 1.5) | 金 (x 1.3) | 火 (x 1.0) | 水 (x 0.7) | 木 (x 0.5) |

*(註：具體係數可根據演算法調優，此處為示意)*

#### **2.3.2 最終得分計算邏輯**

Total\_Score\[Element\] \= (Tiangan\_Count \+ Hidden\_Stem\_Weighted\_Sum) \* Seasonality\_Coefficient

這一步驟將靜態的計數轉化為動態的能量強度（Intensity）。例如，同樣是 2 個木，生在春天的木得分可能是 3.0，而生在秋天的木得分可能被降權為 1.4。這才符合「得時者旺」的命理原則。

---

## **3\. 大運計算 (FortuneCycles)：時間軸的精密工程**

大運（DaYun）代表每十年的外部環境變化。其計算核心在於「起運數（Qi Yun）」，即出生時間與節氣之間的精確換算。

### **3.1 天文曆法基礎：真太陽時與節氣**

後端不能依賴簡單的公曆日期，必須接入高精度的天文曆法庫（如 NASA 的 JPL DE405 或瑞士星曆表 Swiss Ephemeris）。

* **關鍵數據點**：系統需查詢出生時間前後最近的兩個\*\*「節（Jie）」\*\*（立春、驚蟄、清明...），而非「氣（Qi）」（雨水、春分...）。

### **3.2 起運年齡精確計算演算法**

用戶要求「精確到月日」。這涉及到「三天為一歲」的折算邏輯。

#### **3.2.1 順逆行判定邏輯**

在計算時間差之前，必須先決定是向前找節氣還是向後找節氣。

1. **判斷年干陰陽**：  
   * 陽干：甲、丙、戊、庚、壬。  
   * 陰干：乙、丁、己、辛、癸。  
2. **判斷性別**：男 (乾)、女 (坤)。  
3. **邏輯真值表**：

| 性別 | 年干屬性 | 大運排法 | 起運計算方向 |
| :---- | :---- | :---- | :---- |
| 男 | 陽 | 順行 (Forward) | 出生時間 \-\> 下一個節 |
| 男 | 陰 | 逆行 (Backward) | 出生時間 \<- 上一個節 |
| 女 | 陽 | 逆行 (Backward) | 出生時間 \<- 上一個節 |
| 女 | 陰 | 順行 (Forward) | 出生時間 \-\> 下一個節 |

#### **3.2.2 時間折算公式 (Time Dilation Logic)**

傳統口訣為「三天折一歲，一天折四月，一時折五日」。後端需將其轉化為浮點數運算以確保精度。

**演算法步驟**：

1. **計算分差 (Delta Minutes)**：計算出生時間與目標節氣時間的絕對分鐘差 Diff\_Min。  
2. **轉換為代謝天數**：Metabolic\_Days \= Diff\_Min / (24 \* 60)。  
3. **折算為實際歲數**：  
   * 1 代謝日 \= 120 實際日 (約4個月)。  
   * 係數 K \= 120。  
   * Total\_Real\_Days \= Metabolic\_Days \* K。  
4. **轉換為年月日時**：  
   * 將 Total\_Real\_Days 轉換為 Y years, M months, D days。  
   * 此處需注意閏年處理，建議使用標準日期庫（如 Python 的 datetime 或 JS 的 moment.js）進行日期加法。  
5. **得出起運日期**：Start\_Date \= Birth\_Date \+ Total\_Real\_Days。

### **3.3 大運列表生成 (Cycle Generation)**

一旦確定了起運時間與順逆方向，後端即可生成大運列表。

* **基準點**：月柱 (Month Pillar)。  
* **順行**：依六十甲子順序遞增（例：月柱甲子 \-\> 第一運乙丑 \-\> 第二運丙寅）。  
* **逆行**：依六十甲子順序遞減（例：月柱甲子 \-\> 第一運癸亥 \-\> 第二運壬戌）。  
* **數據結構**：  
  JSON  
  "DaYun\_List":

### **3.4 當前大運判定**

系統接收一個查詢日期 Query\_Date（通常為 Now()），遍歷 DaYun\_List。

* **條件**：DaYun\[i\].Start\_Date \<= Query\_Date \< DaYun\[i+1\].Start\_Date。  
* **輸出**：返回當前主管的大運干支，作為後續流年分析的輸入參數。

---

## **4\. 流年計算 (AnnualFortune)：多層次時空交互**

流年（Annual Pillar）是每年變化的干支，它與大運、原局形成複雜的交互網絡。

### **4.1 流年干支與交接點**

* **立春為界**：與公曆元旦（1月1日）或農曆新年（初一）不同，八字流年的切換點嚴格定義在\*\*立春（LiChun）\*\*時刻。  
* **後端邏輯**：  
  * 查詢 Query\_Year 的立春時間戳 T\_LiChun。  
  * 若 Query\_Time \< T\_LiChun，則流年為 Year \- 1 的干支。  
  * 若 Query\_Time \>= T\_LiChun，則流年為 Year 的干支。

### **4.2 流年命宮位置 (Annual Life Palace)**

此功能涉及紫微斗數與八字的結合（小限法）。

* **定位演算法**：  
  * 流年地支決定了流年命宮在紫微盤上的位置。  
  * 例如：流年為「壬寅」，地支為「寅」。  
  * 系統在紫微盤的 12 宮位陣列中，找到地支為「寅」的宮位索引。  
  * 該宮位即被標記為 **"Annual\_Life\_Palace" (流年命宮)**。  
  * **衍生邏輯**：一旦流年命宮確定，其餘 11 宮也隨之旋轉（Shift）。例如，流年命宮的逆時針下一格即為流年兄弟宮。這需要後端動態生成一份「流年宮位映射表」。

### **4.3 流年與本命的關係 (Interaction Matrix)**

這是系統最具分析價值的部分。後端需實作一個 **$N \\times M$ 的交互矩陣**，其中 $N$ 為流年干支，$M$ 為（年柱、月柱、日柱、時柱、大運）。

#### **4.3.1 檢測項目與邏輯**

1. **天干五合 (Stem Combinations)**：  
   * Map: {甲己: 土, 乙庚: 金, 丙辛: 水, 丁壬: 木, 戊癸: 火}。  
   * 檢測：流年天干是否與任意原局天干形成 Key-Value 對。  
2. **地支六沖 (Branch Clashes)**：  
   * Map: {子午, 丑未, 寅申, 卯酉, 辰戌, 巳亥}。  
   * 檢測：流年地支是否沖擊原局地支。  
   * **權重**：沖擊「日支」影響配偶/健康，沖擊「月支」影響父母/事業，沖擊「年支」為犯太歲。  
3. **地支三合/三會 (Harmonious Combinations)**：  
   * 這需要更複雜的集合運算。例如檢測 {申, 子, 辰} 是否同時存在於（流年 \+ 大運 \+ 原局）。  
   * **演算法**：將所有地支放入一個集合 Branch\_Set，檢查是否包含子集 {Shen, Zi, Chen}。若成立，標記為「強水局」。

#### **4.3.2 輸出結構範例**

JSON

"Annual\_Interaction": {  
  "Year\_Stem\_Rel": "Friend (比肩)",  
  "Year\_Branch\_Rel": "Clash (六沖)",  
  "Events":  
}

---

## **5\. 四化飛星 (SiHua Flying Stars)：基於圖論的高階分析**

紫微斗數的精髓在於「四化」（化祿、化權、化科、化忌）的流動。為了滿足「深度研究」與「複雜度高」的要求，我們將紫微盤建模為一個**有向圖 (Directed Graph)**。

### **5.1 圖論建模 (Graph Modeling)**

* **節點 (Nodes, $V$)**：紫微斗數的 12 個宮位（命宮、兄弟、夫妻...）。每個節點包含屬性（宮干、宮職、主星列表）。  
* **邊 (Edges, $E$)**：飛星軌跡。  
  * 每條邊具有 **方向**：從發射宮位指向接受宮位。  
  * 每條邊具有 **類型 (Type)**：祿 (Lu)、權 (Quan)、科 (Ke)、忌 (Ji)。  
  * 每條邊具有 **權重 (Weight)**：生年四化權重最高，大限次之，流年再次之。

### **5.2 壓力匯聚點分析 (Stress Convergence / Sink Analysis)**

用戶詢問「壓力匯聚點」。在圖論中，這對應於尋找 **"In-Degree Centrality" (入度中心性)** 最高的節點，且限定邊的類型為 **"Hua-Ji" (化忌)**。

**演算法步驟**：

1. **初始化圖譜**：  
   * 加入生年四化邊（固定存在）。  
   * 加入大限四化邊（由大限宮干觸發）。  
   * 加入流年四化邊（由流年宮干觸發）。  
   * 加入本宮自化邊（由各宮宮干觸發）。  
2. **過濾邊**：僅保留 Type \== 'Ji' 的邊。  
3. **計算入度 (In-Degree)**：統計每個宮位接收到的化忌數量。  
4. **識別 Sink Node**：  
   * 若某宮位（如疾厄宮）接收到來自「命宮」、「大限命宮」、「流年命宮」的三重化忌，則 In-Degree \= 3。  
   * **結論**：該點為系統崩潰點（Stress Nexus），預示重大健康或情緒危機。

### **5.3 資源源頭分析 (Resource Source / Reverse BFS)**

用戶詢問「資源源頭」。這對應於尋找財富或機遇的來源。我們關注 **"Hua-Lu" (化祿)** 的流動。

**演算法步驟**：

1. **設定目標節點 (Target Node)**：通常為「財帛宮」或「流年財帛宮」。  
2. **反向遍歷 (Reverse Traversal)**：  
   * 尋找所有指向目標節點且 Type \== 'Lu' 的邊。  
   * 追溯這些邊的**源節點 (Source Node)**。  
3. **路徑解析**：  
   * 路徑 A：父母宮 \-\> (化祿) \-\> 財帛宮。解讀：資源來自長輩、遺產或文書合約。  
   * 路徑 B：奴僕宮 (交友) \-\> (化祿) \-\> 財帛宮。解讀：資源來自粉絲、客戶或眾生財。  
   * 路徑 C：官祿宮 \-\> (化祿) \-\> 財帛宮。解讀：資源來自正職工作表現。

### **5.4 循環檢測 (Cycle Detection) \- 業力迴圈**

高階分析還包括檢測圖中的**環 (Cycles)**。

* **場景**：A宮化忌入B，B宮化忌入C，C宮化忌回A。  
* **演算法**：使用 **DFS (深度優先搜尋)** 檢測環路。  
* **解讀**：這代表一種「糾纏」的能量結構。若是「忌」的循環，代表問題在三個領域間互為因果，難以單點突破；若是「祿」的循環，代表良性的生態系閉環。

---

## **6\. 結論與實作建議**

本報告構建了一套完整的玄學後端計算規範。

1. **五行模組**展示了如何通過藏干權重與月令係數，將模糊的命理概念轉化為精確的向量數據。  
2. **大運模組**強調了天文曆法的精確性與順逆行邏輯的嚴密性，確保時間軸的準確。  
3. **流年模組**建立了一個動態的交互矩陣，能自動化識別生命中的關鍵轉折點。  
4. **四化飛星模組**創新地引入了圖論，將複雜的宮位互動簡化為節點與邊的計算，能夠精確定位壓力點與資源點。

**開發建議**：

* **語言選擇**：建議使用 **Python** (因其強大的數據處理庫如 Pandas, NetworkX) 或 **Go** (因其高並發處理能力，適合大量命盤即時運算)。  
* **精度控制**：所有涉及時間與角度的計算，均應使用浮點數雙精度 (Double Precision) 或 Decimal 類型，避免累計誤差。  
* **測試驅動**：命理演算法邊界情況極多（如閏月、早子時/夜子時），必須建立龐大的單元測試庫（Unit Tests）以覆蓋各種極端八字案例。

此架構不僅滿足了用戶當前的需求，更為未來引入機器學習（如基於大量命盤數據的模式識別）奠定了堅實的數據基礎。