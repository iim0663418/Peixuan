# get_daily_transit 工具修復計畫

## 🚨 問題診斷

**症狀**: `get_daily_transit` 工具返回空洞的佔位符內容，缺乏實際的流運資訊

**實際輸出**:
```
【今日流運資訊】
查詢日期：2025-12-31
流年資訊：
建議：根據流運與命盤的互動關係,可以分析今日的吉凶趨勢。
```

## 🔍 根本原因分析

### 1. 數據依賴問題
- 工具依賴 `bazi.fortune.annual` 和 `bazi.fortune.dayun` 數據
- 這些數據可能在 `CalculationResult` 中不存在或未正確計算

### 2. 實現缺陷
- 當 `bazi.fortune` 為空時，工具只輸出標題和通用建議
- 缺乏當日具體的天干地支、流月、流日資訊
- 沒有實際的今日流運計算邏輯

### 3. 功能範圍不足
- 工具名稱是「今日流運」但實際只查詢年運和大運
- 缺少流月、流日、流時的具體計算
- 沒有當日天象、節氣、吉凶神煞等資訊

## 🛠️ 修復方案

### Phase 1: 數據源修復
1. **檢查 UnifiedCalculator**: 確保流年、大運數據正確計算
2. **驗證數據流**: 從計算到工具的數據傳遞鏈路
3. **添加防護邏輯**: 當數據缺失時提供有意義的替代資訊

### Phase 2: 功能增強
1. **添加流月計算**: 基於當前日期計算流月干支
2. **添加流日計算**: 計算當日干支和納音
3. **添加節氣資訊**: 當前節氣和距離下個節氣的天數
4. **添加神煞查詢**: 當日吉凶神煞、宜忌事項

### Phase 3: 輸出優化
1. **結構化輸出**: 清晰的資訊層級和格式
2. **實用建議**: 基於實際流運數據的具體建議
3. **雙語支援**: 完整的中英文輸出格式

## 📋 實施清單

### 緊急修復 (P0)
- [ ] 檢查 `CalculationResult.bazi.fortune` 數據完整性
- [ ] 添加數據缺失時的降級處理
- [ ] 實現基本的流月、流日計算

### 功能完善 (P1)  
- [ ] 集成 lunar-typescript 進行精確的流運計算
- [ ] 添加節氣和神煞查詢
- [ ] 優化輸出格式和實用性

### 測試驗證 (P2)
- [ ] 單元測試覆蓋各種數據情況
- [ ] 集成測試驗證工具在 ReAct 流程中的表現
- [ ] 用戶體驗測試確保輸出有價值

## 🎯 預期結果

修復後的 `get_daily_transit` 應該輸出：

```
【今日流運資訊】

查詢日期：2025-12-31 (農曆十二月初一)
當前節氣：冬至後第10天，距離小寒還有6天

流年資訊：
流年干支：乙巳年 (木蛇年)
太歲：巳蛇，方位東南

流月資訊：
流月干支：己丑月 (土牛月)
月令：丑月，冬季土旺

流日資訊：
流日干支：戊申日 (土猴日)
納音：大驛土
日主與流日：[具體關係分析]

當前大運：
大運干支：庚寅 (金虎運)
運程階段：25-35歲
與流年關係：[具體互動分析]

今日宜忌：
宜：[基於流日干支的具體建議]
忌：[基於流日干支的具體建議]

能量分析：
今日五行偏重：[具體分析]
與命盤互動：[具體建議]
```

## ⚡ 立即行動

建議立即進入 Phase 2 (Plan Validation) 以驗證修復方案的可行性。
