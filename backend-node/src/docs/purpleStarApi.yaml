openapi: 3.0.3
info:
  title: 紫微斗數計算 API
  description: |
    紫微斗數命盤計算和分析 API。提供基於出生資訊的完整命盤計算，
    包括宮位、主星、輔星、四化、大限、小限等詳細資訊。
    
    ## 功能特色
    - 精確的命盤計算算法
    - 支持大限、小限、流年計算
    - 多層次詳細程度（基礎、進階、專家）
    - 完整的錯誤處理和驗證
    - 統一的回應格式
    
  version: 1.0.0
  contact:
    name: 紫微斗數計算服務
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api/v1
    description: 本地開發服務器
  - url: https://api.example.com/v1
    description: 生產環境服務器

paths:
  /purple-star/calculate:
    post:
      summary: 計算紫微斗數命盤
      description: |
        根據提供的出生資訊計算完整的紫微斗數命盤。
        
        該端點支持多種選項來自定義計算結果：
        - 是否包含大限、小限計算
        - 詳細程度選擇（基礎、進階、專家）
        - 計算年齡範圍自定義
        
      operationId: calculatePurpleStar
      tags:
        - 紫微斗數計算
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurpleStarCalculationRequest'
            examples:
              basic_request:
                summary: 基本請求
                description: 只包含必需字段的基本計算請求
                value:
                  birthDate: "1990-02-20"
                  birthTime: "14:30"
                  gender: "male"
              full_request:
                summary: 完整請求
                description: 包含所有可選字段的完整請求
                value:
                  birthDate: "1985-04-15"
                  birthTime: "09:15:30"
                  gender: "female"
                  location:
                    latitude: 25.0330
                    longitude: 121.5654
                    timezone: "Asia/Taipei"
                  options:
                    includeMajorCycles: true
                    includeMinorCycles: true
                    includeAnnualCycles: false
                    detailLevel: "expert"
                    maxAge: 100
      responses:
        '200':
          description: 計算成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PurpleStarCalculationResponse'
              examples:
                success_response:
                  summary: 成功回應示例
                  description: 紫微斗數命盤計算成功的回應
                  value:
                    success: true
                    data:
                      chart:
                        palaces:
                          - name: "命宮"
                            index: 0
                            zhi: "子"
                            gan: "甲"
                            stars:
                              - name: "紫微"
                                type: "main"
                                palaceIndex: 0
                                transformations: ["祿"]
                              - name: "左輔"
                                type: "auxiliary"
                                palaceIndex: 0
                                transformations: []
                        mingPalaceIndex: 0
                        shenPalaceIndex: 6
                        fiveElementsBureau: "水二局"
                        daXian:
                          - startAge: 6
                            endAge: 15
                            palaceName: "命宮"
                            palaceZhi: "子"
                            palaceIndex: 0
                        xiaoXian:
                          - age: 1
                            palaceName: "命宮"
                            palaceZhi: "子"
                            palaceIndex: 0
                      calculationInfo:
                        birthInfo:
                          solarDate: "1990-02-20T14:30:00.000Z"
                          lunarDate: "庚午年正月廿五日未時"
                          gender: "male"
                        options:
                          includeMajorCycles: true
                          includeMinorCycles: true
                          includeAnnualCycles: false
                          detailLevel: "basic"
                          maxAge: 100
                    timestamp: "2023-11-22T10:30:00.000Z"
        '400':
          description: 請求參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                validation_error:
                  summary: 驗證錯誤
                  description: 請求參數驗證失敗
                  value:
                    success: false
                    error: "請求資料驗證失敗"
                    details: "請檢查輸入的出生資訊是否正確"
                    validationErrors:
                      - field: "birthDate"
                        message: "出生日期格式必須為 YYYY-MM-DD"
                        code: "INVALID_FORMAT"
                      - field: "gender"
                        message: "性別必須為 \"male\" 或 \"female\""
                        code: "INVALID_VALUE"
                    timestamp: "2023-11-22T10:30:00.000Z"
        '500':
          description: 服務器內部錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                server_error:
                  summary: 服務器錯誤
                  description: 計算過程中發生內部錯誤
                  value:
                    success: false
                    error: "計算紫微斗數命盤時發生錯誤"
                    details: "內部計算引擎出現異常"
                    timestamp: "2023-11-22T10:30:00.000Z"

  /purple-star/health:
    get:
      summary: 服務健康檢查
      description: 檢查紫微斗數計算服務的運行狀態
      operationId: healthCheck
      tags:
        - 系統監控
      responses:
        '200':
          description: 服務正常運行
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Purple Star service is running"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2023-11-22T10:30:00.000Z"

components:
  schemas:
    PurpleStarCalculationRequest:
      type: object
      required:
        - birthDate
        - birthTime
        - gender
      properties:
        birthDate:
          type: string
          format: date
          description: 出生日期，ISO 8601 格式 (YYYY-MM-DD)
          example: "1990-02-20"
          pattern: '^\d{4}-\d{2}-\d{2}$'
        birthTime:
          type: string
          description: 出生時間，24小時格式 (HH:MM 或 HH:MM:SS)
          example: "14:30"
          pattern: '^([0-1]?[0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?$'
        gender:
          type: string
          enum: [male, female]
          description: 性別
          example: "male"
        location:
          $ref: '#/components/schemas/Location'
        options:
          $ref: '#/components/schemas/CalculationOptions'

    Location:
      type: object
      description: 出生地點資訊（可選）
      properties:
        latitude:
          type: number
          minimum: -90
          maximum: 90
          description: 緯度，範圍 -90 到 90
          example: 25.0330
        longitude:
          type: number
          minimum: -180
          maximum: 180
          description: 經度，範圍 -180 到 180
          example: 121.5654
        timezone:
          type: string
          description: 時區，IANA 時區標識符
          example: "Asia/Taipei"

    CalculationOptions:
      type: object
      description: 計算選項配置
      properties:
        includeMajorCycles:
          type: boolean
          default: true
          description: 是否包含大限計算
          example: true
        includeMinorCycles:
          type: boolean
          default: true
          description: 是否包含小限計算
          example: true
        includeAnnualCycles:
          type: boolean
          default: false
          description: 是否包含流年計算
          example: false
        detailLevel:
          type: string
          enum: [basic, advanced, expert]
          default: basic
          description: 詳細程度等級
          example: "basic"
        maxAge:
          type: integer
          minimum: 1
          maximum: 150
          default: 100
          description: 計算到多少歲（虛歲）
          example: 100

    PurpleStarCalculationResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/CalculationResult'
        timestamp:
          type: string
          format: date-time
          example: "2023-11-22T10:30:00.000Z"

    CalculationResult:
      type: object
      properties:
        chart:
          $ref: '#/components/schemas/PurpleStarChart'
        calculationInfo:
          $ref: '#/components/schemas/CalculationInfo'

    PurpleStarChart:
      type: object
      description: 紫微斗數命盤結構
      properties:
        palaces:
          type: array
          items:
            $ref: '#/components/schemas/Palace'
          description: 十二宮位資訊
        mingPalaceIndex:
          type: integer
          minimum: 0
          maximum: 11
          description: 命宮地支索引 (0-11, 子=0)
          example: 0
        shenPalaceIndex:
          type: integer
          minimum: 0
          maximum: 11
          description: 身宮地支索引 (0-11, 子=0)
          example: 6
        fiveElementsBureau:
          type: string
          description: 五行局
          example: "水二局"
        daXian:
          type: array
          items:
            $ref: '#/components/schemas/DaXianInfo'
          description: 大限資訊
        xiaoXian:
          type: array
          items:
            $ref: '#/components/schemas/XiaoXianInfo'
          description: 小限資訊

    Palace:
      type: object
      description: 宮位資訊
      properties:
        name:
          type: string
          description: 宮位名稱
          example: "命宮"
        index:
          type: integer
          minimum: 0
          maximum: 11
          description: 宮位地支索引 (0-11)
          example: 0
        zhi:
          type: string
          description: 地支
          example: "子"
        gan:
          type: string
          description: 天干
          example: "甲"
        stars:
          type: array
          items:
            $ref: '#/components/schemas/Star'
          description: 宮位內的星曜

    Star:
      type: object
      description: 星曜資訊
      properties:
        name:
          type: string
          description: 星曜名稱
          example: "紫微"
        type:
          type: string
          enum: [main, auxiliary, minor]
          description: 星曜類型
          example: "main"
        palaceIndex:
          type: integer
          minimum: 0
          maximum: 11
          description: 所在宮位索引
          example: 0
        transformations:
          type: array
          items:
            type: string
            enum: [祿, 權, 科, 忌]
          description: 四化狀態
          example: ["祿"]

    DaXianInfo:
      type: object
      description: 大限資訊
      properties:
        startAge:
          type: integer
          description: 起始年齡（虛歲）
          example: 6
        endAge:
          type: integer
          description: 結束年齡（虛歲）
          example: 15
        palaceName:
          type: string
          description: 大限宮位名稱
          example: "命宮"
        palaceZhi:
          type: string
          description: 大限宮位地支
          example: "子"
        palaceIndex:
          type: integer
          minimum: 0
          maximum: 11
          description: 大限宮位索引
          example: 0

    XiaoXianInfo:
      type: object
      description: 小限資訊
      properties:
        age:
          type: integer
          description: 年齡（虛歲）
          example: 25
        palaceName:
          type: string
          description: 小限宮位名稱
          example: "財帛宮"
        palaceZhi:
          type: string
          description: 小限宮位地支
          example: "辰"
        palaceIndex:
          type: integer
          minimum: 0
          maximum: 11
          description: 小限宮位索引
          example: 4

    CalculationInfo:
      type: object
      description: 計算相關資訊
      properties:
        birthInfo:
          $ref: '#/components/schemas/BirthInfo'
        options:
          $ref: '#/components/schemas/ResolvedOptions'

    BirthInfo:
      type: object
      description: 出生資訊
      properties:
        solarDate:
          type: string
          format: date-time
          description: 公曆日期時間
          example: "1990-02-20T14:30:00.000Z"
        lunarDate:
          type: string
          description: 農曆日期時間
          example: "庚午年正月廿五日未時"
        gender:
          type: string
          enum: [male, female]
          description: 性別
          example: "male"
        location:
          $ref: '#/components/schemas/Location'

    ResolvedOptions:
      type: object
      description: 解析後的計算選項
      properties:
        includeMajorCycles:
          type: boolean
          example: true
        includeMinorCycles:
          type: boolean
          example: true
        includeAnnualCycles:
          type: boolean
          example: false
        detailLevel:
          type: string
          enum: [basic, advanced, expert]
          example: "basic"
        maxAge:
          type: integer
          example: 100

    ApiError:
      type: object
      description: API 錯誤回應
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: 錯誤描述
          example: "請求資料驗證失敗"
        details:
          type: string
          description: 錯誤詳細資訊
          example: "請檢查輸入的出生資訊是否正確"
        validationErrors:
          type: array
          items:
            $ref: '#/components/schemas/ValidationError'
          description: 驗證錯誤列表
        timestamp:
          type: string
          format: date-time
          description: 錯誤發生時間
          example: "2023-11-22T10:30:00.000Z"

    ValidationError:
      type: object
      description: 驗證錯誤詳情
      properties:
        field:
          type: string
          description: 出錯的字段名
          example: "birthDate"
        message:
          type: string
          description: 錯誤資訊
          example: "出生日期格式必須為 YYYY-MM-DD"
        code:
          type: string
          description: 錯誤代碼
          example: "INVALID_FORMAT"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 認證令牌

# 全局安全要求（可選，根據需要啟用）
# security:
#   - BearerAuth: []

tags:
  - name: 紫微斗數計算
    description: 紫微斗數命盤計算相關的 API
  - name: 系統監控
    description: 系統狀態監控相關的 API
