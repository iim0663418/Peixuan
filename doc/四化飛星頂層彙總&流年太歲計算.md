# 傳統術數計算引擎實施規劃文件

## 專案名稱：紫微斗數與八字動態分析模組（Computational Metaphysics Engine）

### 版本：1.0

---

## 模組一：實現四化飛星頂層彙總（SiHua Flying Stars Aggregation）

### 1. 目的與頂層架構

本模組旨在將紫微斗數中複雜的宮位飛化互動邏輯，轉化為可程式化、標準化的**圖論（Graph Theory）**計算模型。其核心目標是透過計算**網路拓撲結構**，識別出命盤中的關鍵能量流動與結構特徵，例如壓力匯聚點（Stress Nexus）或業力迴圈（Karmic Cycles）。

### 2. 資料模型與結構化定義（Schema & Data Model）

| 元素名稱 | 命理對應 | 結構化定義 | 備註 | 來源依據 |
| :--- | :--- | :--- | :--- | :--- |
| **節點 (Node)** | 12 個宮位 | `Palace_ID` (e.g., 'Life', 'Siblings') | 命盤的 12 個領域樞紐。 | |
| **邊 (Edge)** | 飛星軌跡 | `Directed_Edge` (`Source_ID` -> `Target_ID`) | 具有方向性，代表能量流動。 | |
| **邊屬性 (Edge Attribute)** | 四化狀態 | `SiHua_Type` (Lu, Quan, Ke, Ji) | 四化是星曜屬性的「修飾符」（Modifier）或「狀態標記」（State Flag）。 | |
| **修飾符觸發源** | 天干 | `Stem_Source` (甲, 乙, 丙...癸) | 四化由天干觸發產生。 | |
| **飛化邏輯** | 主被動關係 | `Source_Palace` (主動發射) / `Target_Palace` (被動接收) | 命宮為思維發動宮位，飛化入其他宮位為影響。 | |

### 3. 核心演算法：循環檢測與結構分析（Cycle Detection & Structural Analysis）

本模組的高階彙總功能必須依賴圖論演算法，特別是針對**化忌（Ji）**和**化祿（Lu）**的循環結構檢測。

#### 3.1 業力迴圈（化忌循環）檢測

| 項目 | 技術要求 | 邏輯說明 | 解讀與輸出 | 來源依據 |
| :--- | :--- | :--- | :--- | :--- |
| **檢測目標** | 僅限於 `SiHua_Type` 為 **忌** 的邊。 | 檢測圖中是否存在閉環：A宮 $\xrightarrow{忌}$ B宮 $\xrightarrow{忌}$ C宮 $\xrightarrow{忌}$ A宮。 | 識別**「糾纏」的能量結構**，表示問題在多個領域間互為因果，**難以單點突破**。 | |
| **演算法** | **DFS（深度優先搜尋）** | 必須應用 DFS 來識別所有具有忌屬性的有向環路 (Cycles)。 | 輸出包含所有構成忌循環的宮位集合。 | |

#### 3.2 資源源頭與能量匯聚點分析

| 項目 | 技術要求 | 邏輯說明 | 來源依據 |
| :--- | :--- | :--- | :--- |
| **祿的生態閉環** | 檢測 `SiHua_Type` 為 **祿** 的環路。 | 識別 A 宮 $\xrightarrow{祿}$ B 宮 $\xrightarrow{祿}$ C 宮 $\xrightarrow{祿}$ A 宮 的結構。 | |
| **壓力匯聚點（Sink Node）** | 計算特定宮位的**入度中心性（In-Degree Centrality）**。 | 僅計算接收到**化忌**的邊的數量。接收到多重化忌的節點即為潛在系統崩潰點。 | |

---

## 模組二：實現流年太歲計算（Annual Tai Sui Calculation）

### 1. 目的與曆法基礎

本模組旨在精確計算特定時間點的流年干支（歲運），並基於八字理論，量化流年與本命盤之間的動態交互關係，尤其專注於「犯太歲」的各類情況。

#### 1.1 時間參數標準化與精度控制

*   **天文校正：** 所有時間輸入必須經過嚴格的數學校正，將現代鐘錶時間（Mean Solar Time）轉換為**真太陽時（True Solar Time）**，以確保命理資訊在跨時區與跨地理維度上的一致性。
*   **精度要求：** 所有涉及時間的計算，建議使用浮點數**雙精度（Double Precision）**或 Decimal 類型，避免累計誤差。

### 2. 流年干支（歲運）排法與界定

#### 2.1 年柱與流年太歲的界定演算法

| 項目 | 邏輯規範 | 演算法/查表依據 | 來源依據 |
| :--- | :--- | :--- | :--- |
| **流年起始** | 嚴格定義於太陽黃經 $315^{\circ}$ 的**立春（LiChun）**時刻。 | 系統必須內建高精度太陽曆算法，查詢目標年份的精確 $T_{LiChun}$。 | |
| **干支計算** | 流年干支（歲運）的排法最為簡單，**不分男女**、不論陰陽，一律依**六十甲子**每年輪流一組干支來管理。 | 依序從出生年干支開始，順數六十甲子。 | |
| **流年太歲宮位** | 流年所行的宮度即為「流年太歲」。 | **流年地支**決定流年命宮在紫微盤上的位置。看一年吉凶以當年太歲位的**「三方四正」**所逢星曜決定。 | |

### 3. 核心演算法：流年與本命的交互矩陣分析

後端應實作一個 **$N \times M$ 的交互矩陣（Interaction Matrix）**，其中 $N$ 為流年干支，$M$ 為原局四柱干支及大運干支。此矩陣負責動態檢測流年與本命盤的結構碰撞。

#### 3.1 地支與流年太歲的五大交互檢測（犯太歲）

系統必須檢測流年地支與本命盤（尤其是年支，即生肖）地支的五大類交互關係：

| 犯太歲類型 | 檢測邏輯 | 具體地支關係範例 | 來源依據 |
| :--- | :--- | :--- | :--- |
| **值太歲 (Zhi Tai Sui)** | 流年地支與本命地支**重疊**（本命年）。 | 2025年乙巳年，屬蛇者值太歲。 | |
| **刑太歲 (Xing Tai Sui)** | 生肖與當年太歲存在**「刑克」關係**。 | 丑刑戌、寅刑巳、子刑卯（三刑、自刑）。 | |
| **沖太歲 (Chong Tai Sui)** | 檢測地支**六沖**（相差 180 度）。 | 子午沖、寅申沖、巳亥沖。 | |
| **破太歲 (Po Tai Sui)** | 檢測地支**六破**情況。 | 子酉破、丑辰破、寅亥破。 | |
| **害太歲 (Hai Tai Sui)** | 檢測地支**六害**情況（又稱穿害）。 | 羊鼠相逢（未子害）、蛇虎害（巳寅害）。 | |

#### 3.2 其他干支交互檢測

系統還需運行以下集合運算，識別流年帶來的動態結構變化：

| 檢測類型 | 檢測邏輯 | 實施方式 | 來源依據 |
| :--- | :--- | :--- | :--- |
| **天干五合 (Stem Combinations)** | 檢測流年天干是否與原局任一天干形成五合 (甲己、乙庚、丙辛、丁壬、戊癸)。 | Map 查詢：`Map: {甲己: 土, 乙庚: 金, ...}`。 | |
| **地支三合/三會 (Harmonious Combinations)** | 檢測（流年 + 大運 + 原局）地支集合是否構成三合（如申子辰合水局）或三會（如寅卯辰會木方）。 | 演算法：將所有地支放入一個集合，檢查是否包含預定義的合/會子集。 | |
| **地支刑（其他）** | 檢測寅申巳、戌丑未等三刑關係。 | 兩地支比較或三地支比較流程。 | |
| **地支破（其他）** | 檢測子酉破、寅亥破等六破關係。 | 兩地支比較流程。 | |

### 4. 實作建議（Implementation Considerations）

1.  **語言與函式庫：** 建議使用 **Python**（適合數據處理和圖論庫如 NetworkX）或 **Go**（適合高並發運算）。
2.  **模組化設計：** 應採用**策略模式（Strategy Pattern）**來設計藏干權重計算模組，以應對不同命理流派（如子平法、新派）對權重分配的不同見解。
3.  **單元測試：** 由於命理演算法邊界情況極多（例如閏月、早子時/夜子時），必須建立**龐大的單元測試庫（Unit Tests）**以覆蓋各種極端八字案例，確保曆法與飛化計算的精確性。
4.  **紫微派別兼容：** 雖然飛星派（北派）強調四化飛星，不看祿存、擎羊、陀羅，但三合派（南派）會重新佈置這些星曜的位置，實作時應考慮模組化設計以兼容不同派別的需求。