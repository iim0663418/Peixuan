# Overview
這個八字應用程式旨在提供一個全面的命理分析平台，結合八字和紫微斗數等多種術數，為使用者提供深入的個人運勢推演和命盤解析。它解決了傳統命理分析複雜、不易理解的問題，透過自動排盤、多術數交互驗證、歷史查詢和多裝置同步等功能，讓使用者能更便捷、準確地了解自身命運軌跡。目標使用者是對命理有興趣的個人，無論是初學者還是有一定基礎的愛好者。其價值在於提供一個整合性、互動性強、資料安全的命理分析工具。

# Core Features
1.  **紫微斗數命盤自動排盤：**
    *   **功能：** 自動計算十二宮位與主／輔星分布。
    *   **重要性：** 提供紫微斗數的核心功能，擴展應用程式的命理分析範圍。
    *   **運作方式：** 根據使用者輸入的出生日期時間和地點，透過後端演算法計算並排布紫微斗數命盤的十二宮位、主星、輔星。
2.  **星曜屬性、宮位吉凶高亮標示：**
    *   **功能：** 在命盤上高亮顯示星曜屬性、宮位吉凶。
    *   **重要性：** 提升使用者對命盤的理解和閱讀效率。
    *   **運作方式：** 前端根據後端返回的命盤資料，對特定星曜和宮位應用視覺化標示。
3.  **流年、四化飛星等動態推演與交互：**
    *   **功能：** 提供流年、四化飛星等動態推演功能，並支援交互操作。
    *   **重要性：** 實現命盤的動態分析，滿足使用者對運勢變化的探究需求。
    *   **運作方式：** 後端計算流年、四化飛星的變化，前端提供時間軸或交互介面供使用者查看不同時間點的命盤變化。
4.  **八字／紫微流年、大運計算：**
    *   **功能：** 計算八字和紫微斗數的流年、大運。
    *   **重要性：** 提供更全面的運勢分析。
    *   **運作方式：** 後端演算法根據出生資料計算八字和大運，以及紫微斗數的流年。
5.  **四化飛星流轉與動態疊加：**
    *   **功能：** 顯示四化飛星的流轉和動態疊加效果。
    *   **重要性：** 深入分析運勢變化的細節。
    *   **運作方式：** 前端視覺化展示四化飛星在不同宮位之間的流轉和疊加影響。
6.  **多術數交互驗證：**
    *   **功能：** 將八字、紫微等多術數結果進行交集／輔證，並分層展示。
    *   **重要性：** 提高分析的準確性和可信度，提供多維度視角。
    *   **運作方式：** 後端整合不同術數的分析結果，前端設計介面分層展示這些結果的異同和輔證關係。
7.  **第三方 API 接入（如姓名學、流年卦）：**
    *   **功能：** 接入外部命理服務 API。
    *   **重要性：** 擴展應用程式的功能範圍，提供更多元的命理服務。
    *   **運作方式：** 後端負責與第三方 API 進行通訊和資料整合。
8.  **用戶資料與歷史查詢：**
    *   **功能：** 雲端儲存查詢紀錄、命盤解析、個人事件與回饋紀錄。
    *   **重要性：** 方便使用者追溯歷史查詢，提供個人化服務。
    *   **運作方式：** 後端資料庫儲存使用者相關資料，前端提供查詢和管理介面。
9.  **多裝置同步、歷史紀錄分組、標記：**
    *   **功能：** 支援多裝置間的資料同步，並可對歷史紀錄進行分組和標記。
    *   **重要性：** 提升使用者體驗，方便管理大量歷史資料。
    *   **運作方式：** 透過用戶認證和資料同步機制實現多裝置同步，前端提供分組和標記功能。
10. **API 查詢與分層結果：**
    *   **功能：** RESTful API 結構化回傳，分層呈現（基礎、進階、專家）。
    *   **重要性：** 滿足不同層級使用者對資訊深度的需求，便於前端展示。
    *   **運作方式：** 後端 API 設計支援不同層級的資料回傳，前端根據使用者權限或選擇顯示對應層級的資訊。
11. **用戶認證與權限管理：**
    *   **功能：** 支援 Email／OAuth 登入，並進行權限分層（匿名、會員、VIP、管理員）。
    *   **重要性：** 確保資料安全，實現功能差異化和商業模式。
    *   **運作方式：** 後端實現使用者認證和授權邏輯，前端提供登入和註冊介面。
12. **匿名轉會員合併、衝突預覽與備份還原：**
    *   **功能：** 處理匿名使用者轉為會員時的資料合併，提供衝突預覽、備份和還原功能。
    *   **重要性：** 確保使用者資料的完整性和連續性。
    *   **運作方式：** 後端處理資料合併邏輯，前端提供合併預覽和操作選項。
13. **分階段 Token 驗證：**
    *   **功能：** 初期開放匿名流量（基本功能），進階功能強制 Token；後期全面推行安全認證。
    *   **重要性：** 逐步實施安全策略，平衡使用者便利性和安全性。
    *   **運作方式：** 後端根據功能和階段設定 Token 驗證策略。
14. **資料合併與衝突處理：**
    *   **功能：** 支援多端／匿名轉會員合併，提供合併預覽、自選優先、自動備份、一鍵還原。
    *   **重要性：** 確保資料一致性，提供資料恢復能力。
    *   **運作方式：** 後端實現複雜的資料合併和衝突解決邏輯，前端提供友善的介面。

# User Experience
*   **使用者角色：** 對命理有興趣的個人，包括初學者（需要直觀易懂的介面和基礎分析）和進階愛好者（需要深入的推演和多術數交互驗證）。
*   **主要使用者流程：**
    1.  使用者進入應用程式。
    2.  輸入出生日期時間和地點。
    3.  選擇八字或紫微斗數排盤。
    4.  查看命盤和基礎分析結果。
    5.  （會員功能）登入後可儲存查詢紀錄，查看歷史命盤。
    6.  （進階功能）進行流年、大運、四化飛星等動態推演。
    7.  （專家功能）查看多術數交互驗證結果。
*   **UI/UX 考量：**
    *   介面應簡潔、直觀，易於操作。
    *   命盤顯示應清晰、美觀，關鍵資訊高亮顯示。
    *   動態推演應有流暢的動畫效果和交互體驗。
    *   資料輸入應有友善的引導和驗證。
    *   多語言支援。

# Technical Architecture
*   **前端：**
    *   Vue/React SPA (沿用現有 Vue.js 專案)。
    *   沿用現有元件，並開發新的紫微斗數相關元件。
    *   預留登入／會員制介面。
    *   國際化（i18n）抽離結構。
    *   透過 RESTful API 取得命盤、紀錄、用戶資訊。
*   **後端：**
    *   Node.js（Express/Koa）或 Python（Flask/FastAPI）。
    *   紫微／八字等演算法模組化（可插拔擴充）。
    *   使用 PostgreSQL／MongoDB 儲存用戶、紀錄、排盤、Token。
*   **Docker-Compose：**
    *   用於容器化部署前端、後端、DB、第三方驗證、快取（Redis）等服務。
    *   實現一鍵部署、自動健康檢查。
*   **API 設計：**
    *   統一 JSON 格式，支援 versioning。
    *   資料分層（基礎、進階、專家）、信心指標、來源標籤。
*   **多裝置同步與資料抽象：**
    *   用戶資料唯一鍵（UUID/ID）、資料來源抽象，便於同步。

# Development Roadmap
*   **MVP Requirements (第一階段已完成八字基礎排盤，第二階段 MVP 聚焦於紫微斗數基礎排盤與用戶認證)：**
    *   紫微斗數命盤自動排盤（十二宮位與主／輔星分布）。
    *   星曜屬性、宮位吉凶高亮標示。
    *   Email／OAuth 登入與基礎用戶認證。
    *   匿名轉會員合併機制（基礎版）。
    *   RESTful API 結構化回傳（基礎層）。
*   **Future Enhancements (未來增強功能)：**
    *   流年、四化飛星等動態推演與交互。
    *   八字／紫微流年、大運計算。
    *   四化飛星流轉與動態疊加。
    *   多術數交互驗證與分層展示。
    *   第三方 API 接入（如姓名學、流年卦）。
    *   用戶資料與歷史查詢（完整功能）。
    *   多裝置同步、歷史紀錄分組、標記。
    *   API 查詢與分層結果（進階、專家層）。
    *   權限分層（VIP、管理員）。
    *   分階段 Token 驗證（全面推行安全認證）。
    *   資料合併與衝突處理（完整功能）。
    *   全程異動紀錄，支援資料還原。

# Logical Dependency Chain
*   **基礎層：**
    *   前端 Vue.js 專案基礎架構。
    *   後端服務基礎架構（Node.js/Python）。
    *   資料庫設定（PostgreSQL/MongoDB）。
    *   Docker-Compose 環境建置。
*   **核心命理功能：**
    *   八字演算法模組（已完成）。
    *   紫微斗數演算法模組（MVP）。
    *   基礎 API 設計（八字/紫微排盤）。
*   **用戶系統：**
    *   用戶認證（Email/OAuth）與權限管理（匿名/會員）。
    *   匿名轉會員資料合併機制。
*   **進階命理功能：**
    *   流年、大運、四化飛星演算法。
    *   多術數交互驗證邏輯。
    *   第三方 API 整合。
*   **資料管理與同步：**
    *   用戶資料與歷史查詢儲存。
    *   多裝置同步機制。
    *   資料合併與衝突處理。
    *   異動紀錄與還原。
*   **安全與擴展：**
    *   分階段 Token 驗證。
    *   API 版本控制。
    *   國際化（i18n）。

# Risks and Mitigations
*   **技術挑戰：**
    *   **複雜命理演算法的準確性：** 確保八字、紫微斗數等演算法的精確性，特別是邊界條件和特殊情況。
        *   **緩解：** 嚴格的單元測試和整合測試，參考多個權威命理資料來源進行交叉驗證。
    *   **前後端資料同步與衝突處理：** 處理多裝置、匿名轉會員時的資料一致性問題。
        *   **緩解：** 設計健壯的資料合併策略，提供預覽、備份和還原功能，並記錄所有異動。
    *   **高併發下的效能：** 隨著使用者增加，確保排盤和查詢的響應速度。
        *   **緩解：** 引入快取機制（Redis），優化資料庫查詢，考慮使用微服務架構。
*   **MVP 定義與實現：**
    *   **風險：** MVP 範圍過大，導致開發週期過長或難以快速驗證市場。
        *   **緩解：** 嚴格控制 MVP 範圍，聚焦於紫微斗數基礎排盤和用戶認證，確保核心功能可用。
*   **資源限制：**
    *   **風險：** 開發人力或時間不足。
        *   **緩解：** 優先開發核心功能，將複雜或非必要功能延後至未來階段。
*   **第三方 API 穩定性：**
    *   **風險：** 依賴的第三方 API 不穩定或收費策略變化。
        *   **緩解：** 選擇可靠的服務商，設計容錯機制和備用方案。

# Appendix
*   **研究發現：**
    *   紫微斗數排盤的複雜性高於八字，需要精確的星曜計算和宮位定義。
    *   多術數交互驗證需要清晰的邏輯和展示方式，避免資訊過載。
*   **技術規範：**
    *   前端使用 Vue 3 + TypeScript。
    *   後端考慮使用 Node.js (Express) 或 Python (FastAPI)，具體選擇待定，但需支援模組化演算法。
    *   資料庫優先考慮 PostgreSQL，用於結構化資料儲存。
    *   API 遵循 RESTful 原則，使用 JWT 進行認證。
