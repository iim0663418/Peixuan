## ğŸ“Š P0 å®®ä½å¤©å¹²ä¿®å¾©å¯¦æ–½å®‰å…¨æ€§è©•ä¼°å®Œæˆ

æˆ‘å·²å®Œæˆå° `.specify/specs/p0_palace_stem_fix.md` å¯¦æ–½è¦æ ¼çš„å…¨é¢å®‰å…¨æ€§è©•ä¼°ã€‚ä»¥ä¸‹æ˜¯æ ¸å¿ƒç™¼ç¾ï¼š

### ğŸ¯ åŸ·è¡Œæ‘˜è¦

**ç¸½é«”è©•ç´š**: ğŸŸ¡ **MEDIUM-HIGH RISK** (ä¸­é«˜é¢¨éšªï¼Œå¯æ§)

**å»ºè­°**: âœ… **æ¢ä»¶æ‰¹å‡†** - å¯ä»¥å¯¦æ–½ï¼Œä½†éœ€æ»¿è¶³å‰ç½®æ¢ä»¶

---

### ğŸ” é—œéµç™¼ç¾

#### âœ… æ­£é¢ç™¼ç¾
1. **æ ¸å¿ƒé‚è¼¯ä¿®å¾©æ­£ç¢º**: äº”è™éæ³•å‰‡å¯¦ä½œç¬¦åˆå‘½ç†ç†è«–
2. **é¡å‹å®‰å…¨å¼·åŒ–**: TypeScript `as const` èˆ‡é¡å‹å®ˆè¡›è¨­è¨ˆå„ªç§€
3. **ç„¡å®‰å…¨æ¼æ´**: ç„¡æ³¨å…¥é¢¨éšªã€DoS é¢¨éšªæˆ–å…¶ä»–å®‰å…¨å•é¡Œ
4. **è¼¸å…¥é©—è­‰å®Œå–„**: é‚Šç•Œæª¢æŸ¥èˆ‡éŒ¯èª¤è™•ç†è‰¯å¥½

#### âš ï¸ é«˜å±é¢¨éšª
1. **ğŸ”´ Risk-01: API ç ´å£æ€§è®Šæ›´**
   - åƒæ•¸å¾ `lifePalaceStem` æ”¹ç‚º `yearStem`
   - å½±éŸ¿ `aggregator.ts` ç­‰èª¿ç”¨é»
   - **ç·©è§£**: éœ€ç¢ºèª `yearStem` è³‡æ–™ä¾†æº

2. **ğŸ”´ Risk-02: è¨ˆç®—çµæœå…¨ç›¤è®Šæ›´**
   - æ‰€æœ‰å››åŒ–è¨ˆç®—çµæœå°‡æ”¹è®Š
   - ç¾æœ‰æ¸¬è©¦å¿«ç…§é æœŸ 100% å¤±æ•ˆ
   - **ç·©è§£**: éœ€æ¸…é™¤ D1 å¿«å–ï¼Œäººå·¥é©—è­‰è‡³å°‘ 5 å€‹å‘½ç›¤

#### ğŸŸ¡ ä¸­å±é¢¨éšª
3. **Risk-03: å¤§é™/æµå¹´é‚è¼¯æœªå®Œå…¨ä¿®æ­£**
   - è¦æ ¼ä¸­ `generateDecadeEdges()` ä»ä½¿ç”¨ç·šæ€§éå¢
   - æ¨™è¨»ç‚º "P2 review"ï¼Œæœªå®Œå…¨è§£æ±º
   - **å»ºè­°**: æ˜ç¢ºå¤§é™/æµå¹´å®®å¹²è¨ˆç®—è¦å‰‡

4. **Risk-04: æ¸¬è©¦è¦†è“‹ç‡ä¸è¶³**
   - ç¾æœ‰æ¸¬è©¦æœªé©—è­‰äº”è™éæ³•å‰‡
   - æœªé©—è­‰å¯¦éš›å››åŒ–å°æ‡‰é—œä¿‚
   - **å»ºè­°**: æ–°å¢å°ˆé–€æ¸¬è©¦æ¡ˆä¾‹

---

### ğŸ“‹ æ‰¹å‡†å‰ç½®æ¢ä»¶ (MUST DO)

#### âœ… Pre-Req 1: API åƒæ•¸ä¾†æºç¢ºèª
```typescript
// ç¢ºèªé€™å€‹å€¼çš„ä¾†æº
const result = aggregateSiHua(palaces, yearStem, decadeStem, annualStem);
//                                      ^^^^^^^^ 
//                                      å¾å“ªè£¡å–å¾—ç”Ÿå¹´å¤©å¹²?
```

#### âœ… Pre-Req 2: å¤§é™/æµå¹´é‚è¼¯æ˜ç¢ºåŒ–
- æ±ºç­–: å¤§é™/æµå¹´æ˜¯å¦ä¹Ÿä½¿ç”¨äº”è™é?
- è‹¥å¦ï¼Œæ˜ç¢ºèªªæ˜ä½¿ç”¨ä½•ç¨®è¦å‰‡

#### âœ… Pre-Req 3: æ¸¬è©¦æ¡ˆä¾‹æº–å‚™
- æº–å‚™è‡³å°‘ 5 å€‹çœŸå¯¦å‘½ç›¤
- äººå·¥è¨ˆç®—æ­£ç¢ºå››åŒ–çµæœ
- ä½œç‚º Golden Standard

---

### ğŸ› ï¸ å»ºè­°æ¸¬è©¦æ¡ˆä¾‹

```typescript
describe('Five Tigers Rule (äº”è™é)', () => {
  it('should correctly apply Five Tigers for ç”²/å·± year', () => {
    expect(getPalaceStem('ç”²', 2)).toBe('ä¸™'); // å¯…å®®
    expect(getPalaceStem('å·±', 2)).toBe('ä¸™');
  });

  it('should generate correct stem sequence for ç”² year', () => {
    const expected = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 
                      'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ç”²', 'ä¹™'];
    expected.forEach((stem, idx) => {
      expect(getPalaceStem('ç”²', idx)).toBe(stem);
    });
  });
});
```

---

### ğŸ“Š æ ¸å¿ƒå·®ç•°å°æ¯”

| é …ç›® | ç¾æœ‰ä»£ç¢¼ | è¦æ ¼è¦æ±‚ | å½±éŸ¿ç­‰ç´š |
|------|----------|----------|----------|
| **å‡½æ•¸ç°½å** | `lifePalaceStem` | `yearStem` | ğŸ”´ **BREAKING** |
| **è¨ˆç®—é‚è¼¯** | ç·šæ€§éå¢ (`line 80`) | äº”è™éæ³•å‰‡ | ğŸ”´ **CRITICAL** |
| **é¡å‹å®‰å…¨** | `string` | `HeavenlyStem \| ''` | ğŸŸ¡ **MODERATE** |
| **å¤§é™/æµå¹´** | ç·šæ€§éå¢ | æœªå®Œå…¨æ˜ç¢º | ğŸŸ¡ **MODERATE** |

**ç¾æœ‰éŒ¯èª¤ä»£ç¢¼** (`edgeGenerator.ts:74-81`):
```typescript
function getPalaceStem(lifePalaceStem: string, palaceIndex: number): string {
  const lifePalaceStemIndex = HEAVENLY_STEMS.indexOf(lifePalaceStem);
  return HEAVENLY_STEMS[(lifePalaceStemIndex + palaceIndex) % 10]; // âŒ éŒ¯èª¤
}
```

---

### ğŸ¯ å¯¦æ–½è·¯å¾‘ (3.5-5.5 å¤©)

**Phase 1: æº–å‚™** (1-2 å¤©)
- ç¢ºèª yearStem ä¾†æº
- æ˜ç¢ºå¤§é™/æµå¹´è¦å‰‡
- æº–å‚™æ¸¬è©¦å‘½ç›¤

**Phase 2: é–‹ç™¼** (1 å¤©)
- æ›´æ–° edgeGenerator.ts
- é‹è¡Œå–®å…ƒæ¸¬è©¦

**Phase 3: é©—è­‰** (1-2 å¤©)
- Staging éƒ¨ç½²
- äººå·¥é©—è­‰ 5 å€‹å‘½ç›¤

**Phase 4: æ¸…ç†** (0.5 å¤©)
- æ¸…é™¤ D1 èˆŠç·©å­˜
- Production éƒ¨ç½²

---

### âœ… æœ€çµ‚å»ºè­°

**å»ºè­°å¯¦æ–½**ï¼Œä½†éœ€æ»¿è¶³:
1. âœ… ç¢ºèª `yearStem` è³‡æ–™ä¾†æº
2. âœ… æ˜ç¢ºå¤§é™/æµå¹´è¦å‰‡
3. âœ… æº–å‚™è‡³å°‘ 5 å€‹æ¸¬è©¦å‘½ç›¤
4. âœ… å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡é” 80%+
5. âš ï¸ **å‹™å¿…æ¸…é™¤ D1 èˆŠç·©å­˜**

å®Œæ•´å ±å‘Šå·²ç”Ÿæˆï¼Œè«‹æˆæ¬Šå¯«å…¥ `.specify/specs/p0_safety_review.md`
