import{d as M,H as i,D as U,m as K,r as L,h as j,E as h,c as p,f as a,w as o,g as u,a as d,t as m,F as w,l as D,b as q,s as g,L as z,e as v,x as W,q as E,K as J,U as P,T as Q,o as f,_ as X}from"./index-BkKrQnZY.js";import{A as Z,I as x}from"./astrologyIntegrationService-CSw67lFs.js";const ee={class:"integrated-analysis-container"},te={class:"card-header"},ae={key:0,class:"header-actions"},oe={class:"analysis-description"},le={class:"steps-list"},se={class:"benefits-section"},ne={class:"placeholder"},re=M({__name:"IntegratedAnalysisView",setup(ie){var I;i.getOrCreateSessionId();const s=Z.createReactiveAnalysis();U(()=>s.integratedAnalysis.value,t=>{t&&console.log("IntegratedAnalysisView - 分析結果更新:",t)});const l=K({birthDate:"",birthTime:"",gender:"male",location:"台北市"}),y=L(typeof l.location=="string"?l.location:((I=l.location)==null?void 0:I.name)||"台北市"),V=t=>{l.location=t},k={birthDate:[{required:!0,message:"請選擇出生日期",trigger:"change"}],birthTime:[{required:!0,message:"請選擇出生時間",trigger:"change"}],gender:[{required:!0,message:"請選擇性別",trigger:"change"}]},$=()=>{P.confirm("確定要清除當前的時運分析結果嗎？","清除資料",{confirmButtonText:"確定",cancelButtonText:"取消",type:"warning"}).then(()=>{i.clearAnalysisData("integrated"),s.integratedAnalysis.value=null,s.confidenceAssessment.value=null,s.error.value=null,h.success("時運分析資料已清除")}).catch(()=>{})},A=async(t=!1)=>{try{console.log("提交分析請求，出生資訊:",l),t||i.saveToStorage(i.STORAGE_KEYS.INTEGRATED_BIRTH_INFO,l),await s.analyze(l,t),s.integratedAnalysis.value?(console.log("分析完成，結果:",s.integratedAnalysis.value),i.saveToStorage(i.STORAGE_KEYS.INTEGRATED_ANALYSIS,s.integratedAnalysis.value),h.success("時運分析完成")):(console.error("分析完成但沒有結果"),h.warning("分析完成但無結果返回"))}catch(e){console.error("分析過程發生錯誤:",e),h.error(e instanceof Error?e.message:"分析失敗，請稍後再試")}},R=()=>{try{console.log("開始從 sessionStorage 載入資料");const t=Object.keys(sessionStorage).filter(n=>n.startsWith("peixuan_"));console.log("sessionStorage 中的相關鍵:",t);const e=i.getFromStorage(i.STORAGE_KEYS.INTEGRATED_BIRTH_INFO);if(e)if(console.log("找到保存的出生資訊"),l.birthDate=e.birthDate||"",l.birthTime=e.birthTime||"",e.gender==="male"||e.gender==="female"?l.gender=e.gender:l.gender="male",e.location){if(typeof e.location=="string")l.location=e.location,y.value=e.location;else if(typeof e.location=="object"){const n=e.location.name||"台北市";l.location=n,y.value=n}}else l.location="台北市",y.value="台北市";else console.log("未找到保存的出生資訊");const r=i.getFromStorage(i.STORAGE_KEYS.INTEGRATED_ANALYSIS);if(console.log("保存的分析結果:",r?"已找到":"未找到"),r&&s.integratedAnalysis)try{if(!r.data||typeof r.data!="object"){console.warn("保存的分析結果資料格式不正確，將清除"),i.clearAnalysisData("integrated");return}const n={...r,success:r.success!==!1,data:{...r.data,integratedAnalysis:r.data.integratedAnalysis||{},analysisInfo:r.data.analysisInfo||{calculationTime:new Date().toISOString(),methodsUsed:["紫微斗數","四柱八字"],confidence:.5}},meta:r.meta||{userRole:"user",features:["sessionStorage"],sources:["cache"]},timestamp:r.timestamp||new Date().toISOString()};s.integratedAnalysis.value=n,console.log("已從 sessionStorage 載入並格式化分析結果"),e&&n.data.integratedAnalysis&&Object.keys(n.data.integratedAnalysis).length===0&&(console.log("檢測到不完整的分析結果，準備重新分析"),A(!0))}catch(n){console.error("解析儲存的分析結果時出錯:",n),i.clearAnalysisData("integrated")}try{console.log("使用增強版存儲服務驗證資料"),Q.validateStorageData()}catch(n){console.error("驗證資料時出錯:",n)}console.log("從 sessionStorage 載入的整合分析資料總結:",{birthInfo:!!e,analysis:!!r})}catch(t){console.error("從 sessionStorage 載入資料時出錯:",t),i.clearAllAstrologyData()}},N=()=>{console.log("IntegratedAnalysisView 組件初始化"),R()};return j(()=>{console.log("IntegratedAnalysisView 組件已掛載");try{N()}catch(t){console.error("組件初始化過程中發生錯誤:",t),i.clearAnalysisData("integrated"),h.warning("資料載入時發生錯誤，已重置分析狀態")}}),(t,e)=>{const r=u("el-button"),n=u("el-card"),b=u("el-col"),O=u("el-date-picker"),_=u("el-form-item"),B=u("el-time-picker"),T=u("el-radio"),Y=u("el-radio-group"),C=u("el-input"),F=u("el-form"),G=u("el-icon"),H=u("el-row");return f(),p("div",ee,[a(H,{gutter:20},{default:o(()=>[a(b,{span:24,class:"mb-4"},{default:o(()=>[a(n,{shadow:"hover"},{header:o(()=>[d("div",te,[e[6]||(e[6]=d("span",null,"時運分析",-1)),g(s).integratedAnalysis.value?(f(),p("div",ae,[a(r,{type:"danger",icon:g(z),onClick:$,size:"small"},{default:o(()=>e[5]||(e[5]=[v(" 清除資料 ")])),_:1,__:[5]},8,["icon"])])):q("",!0)])]),default:o(()=>[d("div",oe,[d("p",null,m(t.$t("astrology.integrated_analysis.description")),1),d("h3",null,m(t.$t("astrology.integrated_analysis.howItWorks.title")),1),d("ol",le,[(f(!0),p(w,null,D(t.$t("astrology.integrated_analysis.howItWorks.steps"),(c,S)=>(f(),p("li",{key:S},m(c),1))),128))]),d("div",se,[e[7]||(e[7]=d("h4",null,"系統優勢：",-1)),d("ul",null,[(f(!0),p(w,null,D(t.$t("features.integrated_analysis.benefits"),(c,S)=>(f(),p("li",{key:S},m(c),1))),128))])])])]),_:1})]),_:1}),a(b,{span:12},{default:o(()=>[a(n,{shadow:"hover"},{header:o(()=>[d("span",null,m(t.$t("astrology.integrated_analysis.inputSection")),1)]),default:o(()=>[a(F,{ref:"analysisForm",model:l,rules:k,onSubmit:W(A,["prevent"])},{default:o(()=>[a(_,{label:t.$t("form.birth_date"),prop:"birthDate"},{default:o(()=>[a(O,{modelValue:l.birthDate,"onUpdate:modelValue":e[0]||(e[0]=c=>l.birthDate=c),type:"date",placeholder:t.$t("form.birth_date"),"value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),a(_,{label:t.$t("form.birth_time"),prop:"birthTime"},{default:o(()=>[a(B,{modelValue:l.birthTime,"onUpdate:modelValue":e[1]||(e[1]=c=>l.birthTime=c),placeholder:t.$t("form.birth_time"),format:"HH:mm","value-format":"HH:mm",style:{width:"100%"}},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),a(_,{label:t.$t("form.gender"),prop:"gender"},{default:o(()=>[a(Y,{modelValue:l.gender,"onUpdate:modelValue":e[2]||(e[2]=c=>l.gender=c)},{default:o(()=>[a(T,{value:"male"},{default:o(()=>[v(m(t.$t("form.genderOptions.male")),1)]),_:1}),a(T,{value:"female"},{default:o(()=>[v(m(t.$t("form.genderOptions.female")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["label"]),a(_,{label:t.$t("form.location"),prop:"location"},{default:o(()=>[a(C,{modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=c=>y.value=c),onInput:V},null,8,["modelValue"])]),_:1},8,["label"]),a(_,null,{default:o(()=>[a(r,{type:"primary",onClick:e[4]||(e[4]=c=>A()),loading:g(s).loading.value,size:"large",style:{width:"100%"}},{default:o(()=>[v(m(t.$t("form.submit")),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(b,{span:12},{default:o(()=>[g(s).integratedAnalysis.value||g(s).loading.value?(f(),E(n,{key:0,shadow:"hover"},{header:o(()=>e[8]||(e[8]=[d("span",null,"分析結果",-1)])),default:o(()=>[a(x,{integratedAnalysis:g(s).integratedAnalysis.value,loading:g(s).loading.value,error:g(s).error.value},null,8,["integratedAnalysis","loading","error"])]),_:1})):(f(),E(n,{key:1,shadow:"hover"},{default:o(()=>[d("div",ne,[a(G,{size:64,color:"#c0c4cc"},{default:o(()=>[a(g(J))]),_:1}),e[9]||(e[9]=d("p",null,"請填寫左側表單開始時運分析",-1)),e[10]||(e[10]=d("p",{class:"sub-text"},"系統將同時計算紫微斗數與八字，並進行交叉分析",-1))])]),_:1}))]),_:1})]),_:1})])}}}),ue=X(re,[["__scopeId","data-v-14110468"]]);export{ue as default};
